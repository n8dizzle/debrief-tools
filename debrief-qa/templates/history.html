{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-christmas-cream">Job History</h1>
        <div class="flex items-center gap-4">
            <span id="total-count" class="text-sm text-gray-500"></span>
            <button onclick="exportCSV()" class="px-4 py-2 bg-dark-card border border-dark-border rounded-lg text-gray-400 hover:text-christmas-cream hover:bg-dark-card-hover transition text-sm">
                Export CSV
            </button>
        </div>
    </div>

    <!-- Date Range Quick Filters -->
    <div class="bg-dark-card rounded-lg border border-dark-border p-4">
        <div class="flex flex-wrap gap-2 mb-4">
            <span class="text-sm text-gray-500 mr-2 self-center">Date Range:</span>
            <button onclick="setDateRange('today')" class="date-btn px-3 py-1.5 rounded-lg text-sm bg-dark-bg border border-dark-border text-gray-400 hover:text-christmas-cream hover:border-christmas-green transition" data-range="today">Today</button>
            <button onclick="setDateRange('yesterday')" class="date-btn px-3 py-1.5 rounded-lg text-sm bg-dark-bg border border-dark-border text-gray-400 hover:text-christmas-cream hover:border-christmas-green transition" data-range="yesterday">Yesterday</button>
            <button onclick="setDateRange('week')" class="date-btn px-3 py-1.5 rounded-lg text-sm bg-dark-bg border border-dark-border text-gray-400 hover:text-christmas-cream hover:border-christmas-green transition" data-range="week">This Week</button>
            <button onclick="setDateRange('last-week')" class="date-btn px-3 py-1.5 rounded-lg text-sm bg-dark-bg border border-dark-border text-gray-400 hover:text-christmas-cream hover:border-christmas-green transition" data-range="last-week">Last Week</button>
            <button onclick="setDateRange('month')" class="date-btn px-3 py-1.5 rounded-lg text-sm bg-dark-bg border border-dark-border text-gray-400 hover:text-christmas-cream hover:border-christmas-green transition" data-range="month">This Month</button>
            <button onclick="setDateRange('last-month')" class="date-btn px-3 py-1.5 rounded-lg text-sm bg-dark-bg border border-dark-border text-gray-400 hover:text-christmas-cream hover:border-christmas-green transition" data-range="last-month">Last Month</button>
            <button onclick="setDateRange('all')" class="date-btn px-3 py-1.5 rounded-lg text-sm bg-dark-bg border border-dark-border text-gray-400 hover:text-christmas-cream hover:border-christmas-green transition active" data-range="all">All Time</button>
            <div class="flex items-center gap-2 ml-4">
                <input type="date" id="date-from" onchange="setDateRange('custom')" class="px-2 py-1 rounded text-sm bg-dark-bg border border-dark-border text-christmas-cream">
                <span class="text-gray-500">to</span>
                <input type="date" id="date-to" onchange="setDateRange('custom')" class="px-2 py-1 rounded text-sm bg-dark-bg border border-dark-border text-christmas-cream">
            </div>
        </div>

        <!-- Other Filters -->
        <div class="flex flex-wrap gap-4 items-end pt-3 border-t border-dark-border">
            <div>
                <label class="block text-xs text-gray-500 mb-1">Technician</label>
                <select id="filter-tech" onchange="loadHistory()" class="px-3 py-2 rounded-lg text-sm min-w-[180px]">
                    <option value="">All Technicians</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">Dispatcher</label>
                <select id="filter-dispatcher" onchange="loadHistory()" class="px-3 py-2 rounded-lg text-sm min-w-[150px]">
                    <option value="">All Dispatchers</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">Score</label>
                <select id="filter-score" onchange="applyClientFilters()" class="px-3 py-2 rounded-lg text-sm min-w-[120px]">
                    <option value="">All Scores</option>
                    <option value="high">80+ (Good)</option>
                    <option value="medium">60-79 (Needs Work)</option>
                    <option value="low">Below 60 (Critical)</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">Issues</label>
                <select id="filter-issues" onchange="applyClientFilters()" class="px-3 py-2 rounded-lg text-sm min-w-[140px]">
                    <option value="">All Jobs</option>
                    <option value="followup">Has Follow-up</option>
                    <option value="failed-payment">Failed Payment</option>
                    <option value="failed-photos">Failed Photos</option>
                    <option value="low-invoice">Low Invoice Score</option>
                </select>
            </div>
            <button onclick="clearFilters()" class="px-3 py-2 text-sm text-gray-500 hover:text-christmas-cream transition">
                Clear All
            </button>
        </div>
    </div>

    <!-- Jobs Table -->
    <div id="history-container" class="bg-dark-card rounded-lg border border-dark-border">
        <div class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-dark-border rounded w-full"></div>
                <div class="h-4 bg-dark-border rounded w-full"></div>
                <div class="h-4 bg-dark-border rounded w-3/4"></div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-between items-center text-sm text-gray-500">
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allData = [];
let filteredData = [];
let currentPage = 0;
const pageSize = 50;
let currentDateFrom = null;
let currentDateTo = null;

function setDateRange(range) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Update active button state
    document.querySelectorAll('.date-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-christmas-green/20', 'text-christmas-cream', 'border-christmas-green');
        btn.classList.add('bg-dark-bg', 'text-gray-400');
    });
    const activeBtn = document.querySelector(`.date-btn[data-range="${range}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active', 'bg-christmas-green/20', 'text-christmas-cream', 'border-christmas-green');
        activeBtn.classList.remove('bg-dark-bg', 'text-gray-400');
    }

    switch (range) {
        case 'today':
            currentDateFrom = today.toISOString().split('T')[0];
            currentDateTo = today.toISOString().split('T')[0];
            break;
        case 'yesterday':
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            currentDateFrom = yesterday.toISOString().split('T')[0];
            currentDateTo = yesterday.toISOString().split('T')[0];
            break;
        case 'week':
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            currentDateFrom = weekStart.toISOString().split('T')[0];
            currentDateTo = today.toISOString().split('T')[0];
            break;
        case 'last-week':
            const lastWeekEnd = new Date(today);
            lastWeekEnd.setDate(today.getDate() - today.getDay() - 1);
            const lastWeekStart = new Date(lastWeekEnd);
            lastWeekStart.setDate(lastWeekEnd.getDate() - 6);
            currentDateFrom = lastWeekStart.toISOString().split('T')[0];
            currentDateTo = lastWeekEnd.toISOString().split('T')[0];
            break;
        case 'month':
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            currentDateFrom = monthStart.toISOString().split('T')[0];
            currentDateTo = today.toISOString().split('T')[0];
            break;
        case 'last-month':
            const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
            const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            currentDateFrom = lastMonthStart.toISOString().split('T')[0];
            currentDateTo = lastMonthEnd.toISOString().split('T')[0];
            break;
        case 'custom':
            currentDateFrom = document.getElementById('date-from').value || null;
            currentDateTo = document.getElementById('date-to').value || null;
            break;
        case 'all':
        default:
            currentDateFrom = null;
            currentDateTo = null;
            break;
    }

    // Update date inputs to reflect selection
    document.getElementById('date-from').value = currentDateFrom || '';
    document.getElementById('date-to').value = currentDateTo || '';

    loadHistory();
}

function getScoreColor(score) {
    if (score >= 80) return 'text-christmas-green-light';
    if (score >= 60) return 'text-christmas-gold';
    return 'text-christmas-brown';
}

function getStatusBadge(status) {
    if (status === 'pass') return '<span class="status-pass px-2 py-0.5 rounded text-xs">Pass</span>';
    if (status === 'fail') return '<span class="status-fail px-2 py-0.5 rounded text-xs">Fail</span>';
    return '<span class="status-na px-2 py-0.5 rounded text-xs">N/A</span>';
}

function formatDate(isoString) {
    if (!isoString) return '--';
    const date = new Date(isoString);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

async function loadHistory() {
    const techFilter = document.getElementById('filter-tech').value;
    const dispatcherFilter = document.getElementById('filter-dispatcher').value;

    let url = `/api/debrief-history?limit=500`;
    if (techFilter) url += `&tech_name=${encodeURIComponent(techFilter)}`;
    if (dispatcherFilter) url += `&dispatcher_id=${dispatcherFilter}`;
    if (currentDateFrom) url += `&date_from=${currentDateFrom}`;
    if (currentDateTo) url += `&date_to=${currentDateTo}`;

    try {
        const response = await fetch(url);
        const result = await response.json();
        allData = result.data;

        document.getElementById('total-count').textContent = `${result.total} jobs`;

        // Populate tech filter if empty
        if (document.getElementById('filter-tech').options.length <= 1) {
            const techs = [...new Set(allData.map(j => j.tech_name))].sort();
            techs.forEach(tech => {
                const opt = document.createElement('option');
                opt.value = tech;
                opt.textContent = tech;
                document.getElementById('filter-tech').appendChild(opt);
            });
        }

        applyClientFilters();
    } catch (error) {
        console.error('Failed to load history:', error);
        document.getElementById('history-container').innerHTML = `
            <div class="p-6 text-center text-christmas-brown">
                Failed to load job history.
            </div>
        `;
    }
}

function applyClientFilters() {
    const scoreFilter = document.getElementById('filter-score').value;
    const issuesFilter = document.getElementById('filter-issues').value;

    filteredData = allData.filter(job => {
        // Score filter
        if (scoreFilter === 'high' && job.composite_score < 80) return false;
        if (scoreFilter === 'medium' && (job.composite_score < 60 || job.composite_score >= 80)) return false;
        if (scoreFilter === 'low' && job.composite_score >= 60) return false;

        // Issues filter
        if (issuesFilter === 'followup' && !job.followup_required) return false;
        if (issuesFilter === 'failed-payment' && job.payment !== 'fail') return false;
        if (issuesFilter === 'failed-photos' && job.photos !== 'fail') return false;
        if (issuesFilter === 'low-invoice' && job.invoice_score >= 5) return false;

        return true;
    });

    currentPage = 0;
    renderTable();
}

function renderTable() {
    const start = currentPage * pageSize;
    const pageData = filteredData.slice(start, start + pageSize);

    if (pageData.length === 0) {
        document.getElementById('history-container').innerHTML = `
            <div class="p-6 text-center text-gray-500">
                No jobs match your filters.
            </div>
        `;
        document.getElementById('pagination').innerHTML = '';
        return;
    }

    document.getElementById('history-container').innerHTML = `
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-dark-border">
                <thead class="bg-dark-bg">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job #</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Technician</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Summary</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-christmas-green uppercase bg-christmas-green/10">Score</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Invoice</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Photos</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Payment</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Estimates</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dispatcher</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Flags</th>
                    </tr>
                </thead>
                <tbody class="bg-dark-card divide-y divide-dark-border">
                    ${pageData.map(job => `
                        <tr class="hover:bg-dark-card-hover cursor-pointer" onclick="window.location='/debrief/${job.job_id}'">
                            <td class="px-3 py-3 whitespace-nowrap">
                                <span class="font-medium text-christmas-cream">${job.job_number}</span>
                            </td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-400">
                                ${formatDate(job.debriefed_at)}
                            </td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-300 max-w-[150px] truncate" title="${job.customer_name}">
                                ${job.customer_name}
                            </td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-300">
                                ${job.tech_name}
                            </td>
                            <td class="px-3 py-3 text-sm text-gray-400 max-w-[200px] relative group">
                                ${job.invoice_summary ? `
                                    <div class="truncate cursor-help">
                                        ${job.invoice_summary.length > 40 ? job.invoice_summary.substring(0, 40) + '...' : job.invoice_summary}
                                    </div>
                                    ${job.invoice_summary.length > 40 ? `
                                        <div class="absolute left-0 top-full mt-1 p-3 bg-dark-bg border border-dark-border rounded-lg shadow-xl z-50 hidden group-hover:block w-80" onclick="event.stopPropagation();">
                                            <div class="text-xs font-medium text-gray-400 mb-1">Invoice Summary</div>
                                            <div class="text-sm text-christmas-cream whitespace-pre-wrap">${job.invoice_summary}</div>
                                        </div>
                                    ` : ''}
                                ` : '<span class="text-gray-600">--</span>'}
                            </td>
                            <td class="px-3 py-3 text-center bg-christmas-green/10">
                                <span class="${getScoreColor(job.composite_score)} font-bold text-lg">${job.composite_score}</span>
                            </td>
                            <td class="px-3 py-3 text-center">
                                <span class="${job.invoice_score >= 7 ? 'text-christmas-green-light' : job.invoice_score >= 5 ? 'text-christmas-gold' : 'text-christmas-brown'}">${job.invoice_score}</span>
                            </td>
                            <td class="px-3 py-3 text-center">${getStatusBadge(job.photos)}</td>
                            <td class="px-3 py-3 text-center">${getStatusBadge(job.payment)}</td>
                            <td class="px-3 py-3 text-center">${getStatusBadge(job.estimates)}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-400">
                                ${job.dispatcher_name}
                            </td>
                            <td class="px-3 py-3 text-center">
                                ${job.followup_required ? '<span class="text-christmas-gold" title="Follow-up Required">!</span>' : ''}
                                ${job.has_notes ? '<span class="text-gray-500" title="Has Notes">*</span>' : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    // Render pagination
    const totalPages = Math.ceil(filteredData.length / pageSize);
    document.getElementById('pagination').innerHTML = `
        <span>Showing ${start + 1}-${Math.min(start + pageSize, filteredData.length)} of ${filteredData.length} jobs</span>
        <div class="flex gap-2">
            <button onclick="prevPage()" ${currentPage === 0 ? 'disabled' : ''}
                class="px-3 py-1 rounded bg-dark-card border border-dark-border ${currentPage === 0 ? 'text-gray-600 cursor-not-allowed' : 'text-gray-400 hover:text-christmas-cream hover:bg-dark-card-hover'}">
                Previous
            </button>
            <span class="px-3 py-1 text-gray-400">Page ${currentPage + 1} of ${totalPages}</span>
            <button onclick="nextPage()" ${currentPage >= totalPages - 1 ? 'disabled' : ''}
                class="px-3 py-1 rounded bg-dark-card border border-dark-border ${currentPage >= totalPages - 1 ? 'text-gray-600 cursor-not-allowed' : 'text-gray-400 hover:text-christmas-cream hover:bg-dark-card-hover'}">
                Next
            </button>
        </div>
    `;
}

function prevPage() {
    if (currentPage > 0) {
        currentPage--;
        renderTable();
        window.scrollTo(0, 0);
    }
}

function nextPage() {
    const totalPages = Math.ceil(filteredData.length / pageSize);
    if (currentPage < totalPages - 1) {
        currentPage++;
        renderTable();
        window.scrollTo(0, 0);
    }
}

function clearFilters() {
    document.getElementById('filter-tech').value = '';
    document.getElementById('filter-dispatcher').value = '';
    document.getElementById('filter-score').value = '';
    document.getElementById('filter-issues').value = '';
    setDateRange('all');
}

function exportCSV() {
    const headers = ['Job #', 'Date', 'Customer', 'Technician', 'Invoice Summary', 'Score', 'Invoice', 'Photos', 'Payment', 'Estimates', 'Membership', 'Reviews', 'Dispatcher', 'Follow-up', 'Invoice Total'];
    const rows = filteredData.map(job => [
        job.job_number,
        job.debriefed_at,
        `"${job.customer_name}"`,
        job.tech_name,
        `"${(job.invoice_summary || '').replace(/"/g, '""')}"`,
        job.composite_score,
        job.invoice_score,
        job.photos,
        job.payment,
        job.estimates,
        job.membership,
        job.reviews,
        job.dispatcher_name,
        job.followup_required ? 'Yes' : 'No',
        job.invoice_total
    ]);

    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `debrief-history-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

// Load dispatchers for filter
async function loadDispatchers() {
    try {
        const response = await fetch('/api/dispatchers');
        const dispatchers = await response.json();
        dispatchers.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = d.name;
            document.getElementById('filter-dispatcher').appendChild(opt);
        });
    } catch (error) {
        console.error('Failed to load dispatchers:', error);
    }
}

// Initial load
loadDispatchers();
loadHistory();
</script>
{% endblock %}
