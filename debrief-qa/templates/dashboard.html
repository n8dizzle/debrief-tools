{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <h1 class="text-2xl font-bold text-christmas-cream">Dashboard</h1>

    <!-- Stats Cards - Top Row -->
    <div id="stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Loading state -->
        <div class="bg-dark-card rounded-lg border border-dark-border p-6 animate-pulse">
            <div class="h-4 bg-dark-border rounded w-1/2 mb-4"></div>
            <div class="h-8 bg-dark-border rounded w-1/4"></div>
        </div>
        <div class="bg-dark-card rounded-lg border border-dark-border p-6 animate-pulse">
            <div class="h-4 bg-dark-border rounded w-1/2 mb-4"></div>
            <div class="h-8 bg-dark-border rounded w-1/4"></div>
        </div>
        <div class="bg-dark-card rounded-lg border border-dark-border p-6 animate-pulse">
            <div class="h-4 bg-dark-border rounded w-1/2 mb-4"></div>
            <div class="h-8 bg-dark-border rounded w-1/4"></div>
        </div>
    </div>

    <!-- Trade Performance Cards - HVAC vs Plumbing -->
    <div id="trade-performance-container">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-christmas-cream">Performance by Trade (This Month)</h2>
            <div class="text-sm text-gray-500">HVAC vs Plumbing</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <!-- Loading state for 6 cards -->
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-6 bg-dark-border rounded w-1/2 mb-2"></div>
                <div class="h-3 bg-dark-border rounded w-full"></div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-6 bg-dark-border rounded w-1/2 mb-2"></div>
                <div class="h-3 bg-dark-border rounded w-full"></div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-6 bg-dark-border rounded w-1/2 mb-2"></div>
                <div class="h-3 bg-dark-border rounded w-full"></div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-6 bg-dark-border rounded w-1/2 mb-2"></div>
                <div class="h-3 bg-dark-border rounded w-full"></div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-6 bg-dark-border rounded w-1/2 mb-2"></div>
                <div class="h-3 bg-dark-border rounded w-full"></div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-6 bg-dark-border rounded w-1/2 mb-2"></div>
                <div class="h-3 bg-dark-border rounded w-full"></div>
            </div>
        </div>
    </div>

    <!-- Dispatcher Performance -->
    <div id="dispatcher-container" class="bg-dark-card rounded-lg border border-dark-border">
        <div class="px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Performance</h2>
        </div>
        <div class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-dark-border rounded w-3/4"></div>
                <div class="h-4 bg-dark-border rounded w-1/2"></div>
            </div>
        </div>
    </div>

    <!-- Dispatcher Accuracy (Spot Checks) -->
    <div id="accuracy-container" class="bg-dark-card rounded-lg border border-dark-border">
        <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
            <div>
                <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Accuracy</h2>
                <p class="text-sm text-gray-500 mt-1">Based on spot check reviews</p>
            </div>
            <a href="/spot-checks" class="px-3 py-1.5 text-sm text-christmas-gold hover:text-christmas-cream transition">
                View Spot Checks →
            </a>
        </div>
        <div class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-dark-border rounded w-3/4"></div>
                <div class="h-4 bg-dark-border rounded w-1/2"></div>
            </div>
        </div>
    </div>

    <!-- Technician Performance -->
    <div id="technician-container" class="bg-dark-card rounded-lg border border-dark-border">
        <div class="px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-christmas-cream">Technician Performance</h2>
        </div>
        <div class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-dark-border rounded w-3/4"></div>
                <div class="h-4 bg-dark-border rounded w-1/2"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let technicianData = null;
let currentTechPeriod = 'today';

function getMetricColor(value, threshold = 80) {
    if (value === null || value === undefined) return 'text-gray-500';
    if (value >= threshold) return 'text-christmas-green-light';
    if (value >= 50) return 'text-christmas-gold';
    return 'text-christmas-brown';
}

function formatMetric(value) {
    if (value === null || value === undefined) return '--';
    return `${Math.round(value)}%`;
}

function renderTradePerformanceCard(title, icon, hvacValue, plumbingValue, isScore = false) {
    // For score, convert 1-10 to percentage for display (x10)
    const hvacDisplay = isScore ? (hvacValue || 0).toFixed(1) : `${hvacValue || 0}%`;
    const plumbingDisplay = isScore ? (plumbingValue || 0).toFixed(1) : `${plumbingValue || 0}%`;

    // For progress bar, use percentage
    const hvacPct = isScore ? (hvacValue || 0) * 10 : (hvacValue || 0);
    const plumbingPct = isScore ? (plumbingValue || 0) * 10 : (plumbingValue || 0);

    // Determine winner
    const hvacWins = hvacPct > plumbingPct;
    const plumbingWins = plumbingPct > hvacPct;
    const tie = hvacPct === plumbingPct;

    return `
        <div class="bg-dark-card rounded-lg border border-dark-border p-4">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-lg">${icon}</span>
                <span class="text-sm font-medium text-christmas-cream">${title}</span>
            </div>
            <div class="space-y-3">
                <!-- HVAC -->
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500 w-12">HVAC</span>
                    <div class="flex-1 h-2 bg-dark-bg rounded-full overflow-hidden">
                        <div class="h-full ${hvacWins ? 'bg-christmas-green' : 'bg-gray-600'} transition-all duration-500" style="width: ${hvacPct}%"></div>
                    </div>
                    <span class="text-sm font-bold ${hvacWins ? 'text-christmas-green-light' : 'text-gray-400'} w-12 text-right">${hvacDisplay}</span>
                    ${hvacWins && !tie ? '<span class="text-yellow-500">&#x1F3C6;</span>' : '<span class="w-5"></span>'}
                </div>
                <!-- Plumbing -->
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500 w-12">Plumb</span>
                    <div class="flex-1 h-2 bg-dark-bg rounded-full overflow-hidden">
                        <div class="h-full ${plumbingWins ? 'bg-blue-500' : 'bg-gray-600'} transition-all duration-500" style="width: ${plumbingPct}%"></div>
                    </div>
                    <span class="text-sm font-bold ${plumbingWins ? 'text-blue-400' : 'text-gray-400'} w-12 text-right">${plumbingDisplay}</span>
                    ${plumbingWins && !tie ? '<span class="text-yellow-500">&#x1F3C6;</span>' : '<span class="w-5"></span>'}
                </div>
            </div>
        </div>
    `;
}

function renderTradePerformance(tradePerformance) {
    if (!tradePerformance || (!tradePerformance.hvac && !tradePerformance.plumbing)) {
        document.getElementById('trade-performance-container').innerHTML = `
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-christmas-cream">Performance by Trade (This Month)</h2>
                <div class="text-sm text-gray-500">HVAC vs Plumbing</div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-8 text-center text-gray-500">
                No debrief data available yet. Complete some debriefs to see trade performance metrics.
            </div>
        `;
        return;
    }

    const hvac = tradePerformance.hvac || {};
    const plumbing = tradePerformance.plumbing || {};

    document.getElementById('trade-performance-container').innerHTML = `
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-christmas-cream">Performance by Trade (This Month)</h2>
            <div class="flex items-center gap-4 text-sm">
                <span class="flex items-center gap-1"><span class="w-3 h-3 bg-christmas-green rounded"></span> HVAC (${hvac.total_debriefed || 0} jobs)</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-500 rounded"></span> Plumbing (${plumbing.total_debriefed || 0} jobs)</span>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            ${renderTradePerformanceCard('Photos', '&#x1F4F7;', hvac.photos_pass_rate, plumbing.photos_pass_rate)}
            ${renderTradePerformanceCard('Payment', '&#x1F4B5;', hvac.payment_pass_rate, plumbing.payment_pass_rate)}
            ${renderTradePerformanceCard('Estimates', '&#x1F4CB;', hvac.estimates_pass_rate, plumbing.estimates_pass_rate)}
            ${renderTradePerformanceCard('Invoice Score', '&#x1F4DD;', hvac.avg_invoice_score, plumbing.avg_invoice_score, true)}
            ${renderTradePerformanceCard('Equipment Added', '&#x1F527;', hvac.equipment_added_rate, plumbing.equipment_added_rate)}
            ${renderTradePerformanceCard('Materials', '&#x1F4B0;', hvac.materials_on_invoice_rate, plumbing.materials_on_invoice_rate)}
        </div>
    `;
}

function renderTechnicianTable(period) {
    currentTechPeriod = period;
    const data = technicianData ? technicianData[period] : [];

    if (!data || data.length === 0) {
        document.getElementById('technician-container').innerHTML = `
            <div class="px-6 py-4 border-b border-dark-border">
                <h2 class="text-lg font-semibold text-christmas-cream">Technician Performance</h2>
            </div>
            <div class="p-6 text-center text-gray-500">
                No technician data available for this period.
            </div>
        `;
        return;
    }

    document.getElementById('technician-container').innerHTML = `
        <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
            <h2 class="text-lg font-semibold text-christmas-cream">Technician Performance</h2>
            <div class="flex gap-1 bg-dark-bg rounded-lg p-1">
                <button onclick="renderTechnicianTable('today')"
                    class="px-3 py-1 text-sm rounded ${period === 'today' ? 'bg-dark-card text-christmas-cream font-medium' : 'text-gray-500 hover:text-christmas-cream'}">
                    Today
                </button>
                <button onclick="renderTechnicianTable('this_week')"
                    class="px-3 py-1 text-sm rounded ${period === 'this_week' ? 'bg-dark-card text-christmas-cream font-medium' : 'text-gray-500 hover:text-christmas-cream'}">
                    This Week
                </button>
                <button onclick="renderTechnicianTable('this_month')"
                    class="px-3 py-1 text-sm rounded ${period === 'this_month' ? 'bg-dark-card text-christmas-cream font-medium' : 'text-gray-500 hover:text-christmas-cream'}">
                    This Month
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-dark-border">
                <thead class="bg-dark-bg">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Technician</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="Total number of jobs debriefed by this technician in the selected time period.">
                            <span class="cursor-help">Jobs</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-christmas-green uppercase bg-christmas-green/10" title="Overall performance score (0-100). Weighted average: Photos, Payment, Estimates are critical metrics; Invoice quality counts 2x.">
                            <span class="cursor-help">Score</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="Average invoice summary quality rating (1-10). Measures how well the tech documented the work performed and customer communication.">
                            <span class="cursor-help">Invoice</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-christmas-brown uppercase bg-christmas-brown/10" title="CRITICAL: Percentage of jobs with proper before/after photos uploaded. Required for quality assurance and customer documentation.">
                            <span class="cursor-help">Photos</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-christmas-brown uppercase bg-christmas-brown/10" title="CRITICAL: Percentage of jobs where payment was collected on-site. Directly impacts company cash flow.">
                            <span class="cursor-help">Payment</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-christmas-brown uppercase bg-christmas-brown/10" title="CRITICAL: Percentage of jobs where estimates or replacement options were discussed with the customer. Key for upselling and future business.">
                            <span class="cursor-help">Estimates</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="Percentage of jobs where membership/maintenance plans were offered to the customer. Important for recurring revenue.">
                            <span class="cursor-help">Membership</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="Percentage of jobs where the tech asked the customer to leave a Google review. Helps build online reputation and SEO.">
                            <span class="cursor-help">Reviews</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-dark-card divide-y divide-dark-border">
                    ${data.map(t => `
                        <tr class="hover:bg-dark-card-hover">
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="font-medium text-christmas-cream">${t.tech_name}</span>
                            </td>
                            <td class="px-4 py-3 text-center text-gray-400">${t.jobs_debriefed}</td>
                            <td class="px-4 py-3 text-center bg-christmas-green/10">
                                <span class="${t.composite_score >= 80 ? 'text-christmas-green-light' : t.composite_score >= 60 ? 'text-christmas-gold' : 'text-christmas-brown'} font-bold text-lg">
                                    ${t.composite_score}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="${t.avg_invoice_score >= 7 ? 'text-christmas-green-light' : t.avg_invoice_score >= 5 ? 'text-christmas-gold' : 'text-christmas-brown'} font-medium">
                                    ${t.avg_invoice_score !== null ? t.avg_invoice_score.toFixed(1) : '--'}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center bg-christmas-brown/10">
                                <span class="${getMetricColor(t.photos_pass_rate)} font-semibold">${formatMetric(t.photos_pass_rate)}</span>
                            </td>
                            <td class="px-4 py-3 text-center bg-christmas-brown/10">
                                <span class="${getMetricColor(t.payment_pass_rate)} font-semibold">${formatMetric(t.payment_pass_rate)}</span>
                            </td>
                            <td class="px-4 py-3 text-center bg-christmas-brown/10">
                                <span class="${getMetricColor(t.estimates_pass_rate)} font-semibold">${formatMetric(t.estimates_pass_rate)}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="${getMetricColor(t.membership_pass_rate, 50)}">${formatMetric(t.membership_pass_rate)}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="${getMetricColor(t.google_reviews_pass_rate, 50)}">${formatMetric(t.google_reviews_pass_rate)}</span>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <div class="px-4 py-3 bg-dark-bg text-xs text-gray-500 border-t border-dark-border flex items-center gap-4">
            <span><span class="inline-block px-2 py-1 bg-christmas-green/20 text-christmas-green-light rounded font-medium">Score</span> = Weighted composite (Photos, Payment, Estimates, Invoice = 2x weight)</span>
            <span><span class="inline-block px-2 py-1 bg-christmas-brown/20 text-christmas-brown rounded">Critical</span> = High priority metrics</span>
        </div>
    `;
}

async function loadTechnicianStats() {
    try {
        const response = await fetch('/api/technician-stats');
        technicianData = await response.json();
        renderTechnicianTable(currentTechPeriod);
    } catch (error) {
        console.error('Failed to load technician stats:', error);
        document.getElementById('technician-container').innerHTML = `
            <div class="px-6 py-4 border-b border-dark-border">
                <h2 class="text-lg font-semibold text-christmas-cream">Technician Performance</h2>
            </div>
            <div class="p-6 text-center text-christmas-brown">
                Failed to load technician data.
            </div>
        `;
    }
}

async function loadDashboard() {
    try {
        const response = await fetch('/api/dashboard');
        const data = await response.json();

        // Render stats
        document.getElementById('stats-container').innerHTML = `
            <div class="bg-dark-card rounded-lg border border-dark-border p-6">
                <div class="text-sm font-medium text-gray-500">Today</div>
                <div class="mt-2 flex items-baseline justify-between">
                    <div class="text-3xl font-bold ${data.today.completion_rate >= 100 ? 'text-christmas-green-light' : 'text-christmas-gold'}">
                        ${data.today.completion_rate}%
                    </div>
                    <div class="text-sm text-gray-500">
                        ${data.today.total_debriefed} / ${data.today.total_completed_jobs} jobs
                    </div>
                </div>
                <div class="mt-2 text-sm text-gray-500">
                    ${data.today.pending_debrief} pending
                </div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-6">
                <div class="text-sm font-medium text-gray-500">This Week</div>
                <div class="mt-2 flex items-baseline justify-between">
                    <div class="text-3xl font-bold ${data.this_week.completion_rate >= 100 ? 'text-christmas-green-light' : 'text-christmas-gold'}">
                        ${data.this_week.completion_rate}%
                    </div>
                    <div class="text-sm text-gray-500">
                        ${data.this_week.total_debriefed} / ${data.this_week.total_completed_jobs} jobs
                    </div>
                </div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-6">
                <div class="text-sm font-medium text-gray-500">This Month</div>
                <div class="mt-2 flex items-baseline justify-between">
                    <div class="text-3xl font-bold ${data.this_month.completion_rate >= 100 ? 'text-christmas-green-light' : 'text-christmas-gold'}">
                        ${data.this_month.completion_rate}%
                    </div>
                    <div class="text-sm text-gray-500">
                        ${data.this_month.total_debriefed} / ${data.this_month.total_completed_jobs} jobs
                    </div>
                </div>
            </div>
        `;

        // Render trade performance cards
        renderTradePerformance(data.trade_performance);

        // Render dispatcher performance
        if (data.dispatchers && data.dispatchers.length > 0) {
            document.getElementById('dispatcher-container').innerHTML = `
                <div class="px-6 py-4 border-b border-dark-border">
                    <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Performance</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-dark-border">
                        <thead class="bg-dark-bg">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dispatcher</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Today</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">This Week</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">This Month</th>
                            </tr>
                        </thead>
                        <tbody class="bg-dark-card divide-y divide-dark-border">
                            ${data.dispatchers.map(d => `
                                <tr class="hover:bg-dark-card-hover">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <span class="font-medium text-christmas-cream">${d.dispatcher_name}</span>
                                            ${d.is_primary ? '<span class="ml-2 px-2 py-1 text-xs bg-christmas-green/20 text-christmas-green-light rounded-full">Primary</span>' : ''}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-center text-christmas-cream">${d.debriefs_completed_today}</td>
                                    <td class="px-6 py-4 text-center text-christmas-cream">${d.debriefs_completed_this_week}</td>
                                    <td class="px-6 py-4 text-center text-christmas-cream">${d.debriefs_completed_this_month}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } else {
            document.getElementById('dispatcher-container').innerHTML = `
                <div class="px-6 py-4 border-b border-dark-border">
                    <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Performance</h2>
                </div>
                <div class="p-6 text-center text-gray-500">
                    <p>No dispatchers configured.</p>
                    <button onclick="setupDispatchers()" class="mt-4 bg-christmas-green hover:bg-christmas-green-dark text-christmas-cream px-4 py-2 rounded transition">
                        Setup Default Dispatchers
                    </button>
                </div>
            `;
        }

    } catch (error) {
        console.error('Failed to load dashboard:', error);
    }
}

async function setupDispatchers() {
    try {
        await fetch('/api/dispatchers/setup', { method: 'POST' });
        location.reload();
    } catch (error) {
        console.error('Failed to setup dispatchers:', error);
    }
}

async function loadDispatcherAccuracy() {
    try {
        const response = await fetch('/api/spot-checks/dispatcher-stats');
        const stats = await response.json();

        if (!stats || stats.length === 0) {
            document.getElementById('accuracy-container').innerHTML = `
                <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Accuracy</h2>
                        <p class="text-sm text-gray-500 mt-1">Based on spot check reviews</p>
                    </div>
                    <a href="/spot-checks" class="px-3 py-1.5 text-sm text-christmas-gold hover:text-christmas-cream transition">
                        View Spot Checks →
                    </a>
                </div>
                <div class="p-6 text-center text-gray-500">
                    No spot check data available yet. Complete spot checks to see dispatcher accuracy.
                </div>
            `;
            return;
        }

        // Filter to only show dispatchers with spot check data
        const withData = stats.filter(s => s.sample_size > 0);

        if (withData.length === 0) {
            document.getElementById('accuracy-container').innerHTML = `
                <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Accuracy</h2>
                        <p class="text-sm text-gray-500 mt-1">Based on spot check reviews</p>
                    </div>
                    <a href="/spot-checks" class="px-3 py-1.5 text-sm text-christmas-gold hover:text-christmas-cream transition">
                        View Spot Checks →
                    </a>
                </div>
                <div class="p-6 text-center text-gray-500">
                    No completed spot checks yet. Complete reviews to see accuracy data.
                </div>
            `;
            return;
        }

        document.getElementById('accuracy-container').innerHTML = `
            <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Accuracy</h2>
                    <p class="text-sm text-gray-500 mt-1">Based on spot check reviews</p>
                </div>
                <a href="/spot-checks" class="px-3 py-1.5 text-sm text-christmas-gold hover:text-christmas-cream transition">
                    View Spot Checks →
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-dark-border">
                    <thead class="bg-dark-bg">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dispatcher</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Checked</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-christmas-green uppercase bg-christmas-green/10">Accuracy</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Avg Grade</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Photos</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Invoice</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Payment</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Estimates</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Coaching</th>
                        </tr>
                    </thead>
                    <tbody class="bg-dark-card divide-y divide-dark-border">
                        ${withData.map(d => `
                            <tr class="hover:bg-dark-card-hover">
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <span class="font-medium text-christmas-cream">${d.dispatcher_name}</span>
                                    ${d.is_primary ? '<span class="ml-2 px-1.5 py-0.5 text-xs bg-christmas-green/20 text-christmas-green-light rounded">Primary</span>' : ''}
                                </td>
                                <td class="px-4 py-3 text-center text-gray-400">${d.sample_size}</td>
                                <td class="px-4 py-3 text-center bg-christmas-green/10">
                                    <span class="${d.overall_accuracy >= 90 ? 'text-christmas-green-light' : d.overall_accuracy >= 70 ? 'text-christmas-gold' : 'text-christmas-brown'} font-bold text-lg">
                                        ${d.overall_accuracy !== null ? d.overall_accuracy + '%' : '--'}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="${d.avg_grade >= 8 ? 'text-christmas-green-light' : d.avg_grade >= 6 ? 'text-christmas-gold' : 'text-christmas-brown'} font-medium">
                                        ${d.avg_grade !== null ? d.avg_grade.toFixed(1) : '--'}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="${d.photos_accuracy >= 90 ? 'text-christmas-green-light' : d.photos_accuracy >= 70 ? 'text-christmas-gold' : 'text-christmas-brown'}">
                                        ${d.photos_accuracy !== null ? d.photos_accuracy + '%' : '--'}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="${d.invoice_score_accuracy >= 90 ? 'text-christmas-green-light' : d.invoice_score_accuracy >= 70 ? 'text-christmas-gold' : 'text-christmas-brown'}">
                                        ${d.invoice_score_accuracy !== null ? d.invoice_score_accuracy + '%' : '--'}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="${d.payment_accuracy >= 90 ? 'text-christmas-green-light' : d.payment_accuracy >= 70 ? 'text-christmas-gold' : 'text-christmas-brown'}">
                                        ${d.payment_accuracy !== null ? d.payment_accuracy + '%' : '--'}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="${d.estimates_accuracy >= 90 ? 'text-christmas-green-light' : d.estimates_accuracy >= 70 ? 'text-christmas-gold' : 'text-christmas-brown'}">
                                        ${d.estimates_accuracy !== null ? d.estimates_accuracy + '%' : '--'}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    ${d.coaching_needed_count > 0 ?
                                        `<span class="px-2 py-1 text-xs rounded bg-christmas-gold/20 text-christmas-gold">${d.coaching_needed_count}</span>` :
                                        '<span class="text-gray-500">0</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            <div class="px-4 py-3 bg-dark-bg text-xs text-gray-500 border-t border-dark-border">
                Accuracy = Weighted average of correct items. Green (90%+), Yellow (70-89%), Red (&lt;70%)
            </div>
        `;
    } catch (error) {
        console.error('Failed to load dispatcher accuracy:', error);
        document.getElementById('accuracy-container').innerHTML = `
            <div class="px-6 py-4 border-b border-dark-border">
                <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Accuracy</h2>
            </div>
            <div class="p-6 text-center text-christmas-brown">
                Failed to load accuracy data.
            </div>
        `;
    }
}

// Load on page load
loadDashboard();
loadTechnicianStats();
loadDispatcherAccuracy();

// Refresh every 60 seconds
setInterval(() => {
    loadDashboard();
    loadTechnicianStats();
    loadDispatcherAccuracy();
}, 60000);
</script>
{% endblock %}
