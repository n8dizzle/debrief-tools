{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <h1 class="text-2xl font-bold text-christmas-cream">Dashboard</h1>

    <!-- Stats Cards -->
    <div id="stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Loading state -->
        <div class="bg-dark-card rounded-lg border border-dark-border p-6 animate-pulse">
            <div class="h-4 bg-dark-border rounded w-1/2 mb-4"></div>
            <div class="h-8 bg-dark-border rounded w-1/4"></div>
        </div>
        <div class="bg-dark-card rounded-lg border border-dark-border p-6 animate-pulse">
            <div class="h-4 bg-dark-border rounded w-1/2 mb-4"></div>
            <div class="h-8 bg-dark-border rounded w-1/4"></div>
        </div>
        <div class="bg-dark-card rounded-lg border border-dark-border p-6 animate-pulse">
            <div class="h-4 bg-dark-border rounded w-1/2 mb-4"></div>
            <div class="h-8 bg-dark-border rounded w-1/4"></div>
        </div>
    </div>

    <!-- Dispatcher Performance -->
    <div id="dispatcher-container" class="bg-dark-card rounded-lg border border-dark-border">
        <div class="px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Performance</h2>
        </div>
        <div class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-dark-border rounded w-3/4"></div>
                <div class="h-4 bg-dark-border rounded w-1/2"></div>
            </div>
        </div>
    </div>

    <!-- Technician Performance -->
    <div id="technician-container" class="bg-dark-card rounded-lg border border-dark-border">
        <div class="px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-christmas-cream">Technician Performance</h2>
        </div>
        <div class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-dark-border rounded w-3/4"></div>
                <div class="h-4 bg-dark-border rounded w-1/2"></div>
            </div>
        </div>
    </div>

    <!-- Pending Jobs Preview -->
    <div id="pending-container" class="bg-dark-card rounded-lg border border-dark-border">
        <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
            <h2 class="text-lg font-semibold text-christmas-cream">Pending Debriefs</h2>
            <a href="/queue" class="text-christmas-green-light hover:text-christmas-green text-sm">View All â†’</a>
        </div>
        <div class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-dark-border rounded w-full"></div>
                <div class="h-4 bg-dark-border rounded w-full"></div>
                <div class="h-4 bg-dark-border rounded w-3/4"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let technicianData = null;
let currentTechPeriod = 'today';

function getMetricColor(value, threshold = 80) {
    if (value === null || value === undefined) return 'text-gray-500';
    if (value >= threshold) return 'text-christmas-green-light';
    if (value >= 50) return 'text-christmas-gold';
    return 'text-christmas-brown';
}

function formatMetric(value) {
    if (value === null || value === undefined) return '--';
    return `${Math.round(value)}%`;
}

function renderTechnicianTable(period) {
    currentTechPeriod = period;
    const data = technicianData ? technicianData[period] : [];

    if (!data || data.length === 0) {
        document.getElementById('technician-container').innerHTML = `
            <div class="px-6 py-4 border-b border-dark-border">
                <h2 class="text-lg font-semibold text-christmas-cream">Technician Performance</h2>
            </div>
            <div class="p-6 text-center text-gray-500">
                No technician data available for this period.
            </div>
        `;
        return;
    }

    document.getElementById('technician-container').innerHTML = `
        <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
            <h2 class="text-lg font-semibold text-christmas-cream">Technician Performance</h2>
            <div class="flex gap-1 bg-dark-bg rounded-lg p-1">
                <button onclick="renderTechnicianTable('today')"
                    class="px-3 py-1 text-sm rounded ${period === 'today' ? 'bg-dark-card text-christmas-cream font-medium' : 'text-gray-500 hover:text-christmas-cream'}">
                    Today
                </button>
                <button onclick="renderTechnicianTable('this_week')"
                    class="px-3 py-1 text-sm rounded ${period === 'this_week' ? 'bg-dark-card text-christmas-cream font-medium' : 'text-gray-500 hover:text-christmas-cream'}">
                    This Week
                </button>
                <button onclick="renderTechnicianTable('this_month')"
                    class="px-3 py-1 text-sm rounded ${period === 'this_month' ? 'bg-dark-card text-christmas-cream font-medium' : 'text-gray-500 hover:text-christmas-cream'}">
                    This Month
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-dark-border">
                <thead class="bg-dark-bg">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Technician</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jobs</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-christmas-green uppercase bg-christmas-green/10" title="Weighted average of all metrics">
                            <span class="cursor-help">Score</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="Average score 1-10">
                            <span class="cursor-help">Invoice</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-christmas-brown uppercase bg-christmas-brown/10" title="Critical: Photos Pass Rate">
                            <span class="cursor-help">Photos</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-christmas-brown uppercase bg-christmas-brown/10" title="Critical: Payment Collected Rate">
                            <span class="cursor-help">Payment</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-christmas-brown uppercase bg-christmas-brown/10" title="Critical: Estimates/Replacement Discussed">
                            <span class="cursor-help">Estimates</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="Membership Offered">
                            <span class="cursor-help">Membership</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="Google Reviews Discussed">
                            <span class="cursor-help">Reviews</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-dark-card divide-y divide-dark-border">
                    ${data.map(t => `
                        <tr class="hover:bg-dark-card-hover">
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="font-medium text-christmas-cream">${t.tech_name}</span>
                            </td>
                            <td class="px-4 py-3 text-center text-gray-400">${t.jobs_debriefed}</td>
                            <td class="px-4 py-3 text-center bg-christmas-green/10">
                                <span class="${t.composite_score >= 80 ? 'text-christmas-green-light' : t.composite_score >= 60 ? 'text-christmas-gold' : 'text-christmas-brown'} font-bold text-lg">
                                    ${t.composite_score}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="${t.avg_invoice_score >= 7 ? 'text-christmas-green-light' : t.avg_invoice_score >= 5 ? 'text-christmas-gold' : 'text-christmas-brown'} font-medium">
                                    ${t.avg_invoice_score !== null ? t.avg_invoice_score.toFixed(1) : '--'}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center bg-christmas-brown/10">
                                <span class="${getMetricColor(t.photos_pass_rate)} font-semibold">${formatMetric(t.photos_pass_rate)}</span>
                            </td>
                            <td class="px-4 py-3 text-center bg-christmas-brown/10">
                                <span class="${getMetricColor(t.payment_pass_rate)} font-semibold">${formatMetric(t.payment_pass_rate)}</span>
                            </td>
                            <td class="px-4 py-3 text-center bg-christmas-brown/10">
                                <span class="${getMetricColor(t.estimates_pass_rate)} font-semibold">${formatMetric(t.estimates_pass_rate)}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="${getMetricColor(t.membership_pass_rate, 50)}">${formatMetric(t.membership_pass_rate)}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="${getMetricColor(t.google_reviews_pass_rate, 50)}">${formatMetric(t.google_reviews_pass_rate)}</span>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <div class="px-4 py-3 bg-dark-bg text-xs text-gray-500 border-t border-dark-border flex items-center gap-4">
            <span><span class="inline-block px-2 py-1 bg-christmas-green/20 text-christmas-green-light rounded font-medium">Score</span> = Weighted composite (Photos, Payment, Estimates, Invoice = 2x weight)</span>
            <span><span class="inline-block px-2 py-1 bg-christmas-brown/20 text-christmas-brown rounded">Critical</span> = High priority metrics</span>
        </div>
    `;
}

async function loadTechnicianStats() {
    try {
        const response = await fetch('/api/technician-stats');
        technicianData = await response.json();
        renderTechnicianTable(currentTechPeriod);
    } catch (error) {
        console.error('Failed to load technician stats:', error);
        document.getElementById('technician-container').innerHTML = `
            <div class="px-6 py-4 border-b border-dark-border">
                <h2 class="text-lg font-semibold text-christmas-cream">Technician Performance</h2>
            </div>
            <div class="p-6 text-center text-christmas-brown">
                Failed to load technician data.
            </div>
        `;
    }
}

async function loadDashboard() {
    try {
        const response = await fetch('/api/dashboard');
        const data = await response.json();

        // Render stats
        document.getElementById('stats-container').innerHTML = `
            <div class="bg-dark-card rounded-lg border border-dark-border p-6">
                <div class="text-sm font-medium text-gray-500">Today</div>
                <div class="mt-2 flex items-baseline justify-between">
                    <div class="text-3xl font-bold ${data.today.completion_rate >= 100 ? 'text-christmas-green-light' : 'text-christmas-gold'}">
                        ${data.today.completion_rate}%
                    </div>
                    <div class="text-sm text-gray-500">
                        ${data.today.total_debriefed} / ${data.today.total_completed_jobs} jobs
                    </div>
                </div>
                <div class="mt-2 text-sm text-gray-500">
                    ${data.today.pending_debrief} pending
                </div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-6">
                <div class="text-sm font-medium text-gray-500">This Week</div>
                <div class="mt-2 flex items-baseline justify-between">
                    <div class="text-3xl font-bold ${data.this_week.completion_rate >= 100 ? 'text-christmas-green-light' : 'text-christmas-gold'}">
                        ${data.this_week.completion_rate}%
                    </div>
                    <div class="text-sm text-gray-500">
                        ${data.this_week.total_debriefed} / ${data.this_week.total_completed_jobs} jobs
                    </div>
                </div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-6">
                <div class="text-sm font-medium text-gray-500">This Month</div>
                <div class="mt-2 flex items-baseline justify-between">
                    <div class="text-3xl font-bold ${data.this_month.completion_rate >= 100 ? 'text-christmas-green-light' : 'text-christmas-gold'}">
                        ${data.this_month.completion_rate}%
                    </div>
                    <div class="text-sm text-gray-500">
                        ${data.this_month.total_debriefed} / ${data.this_month.total_completed_jobs} jobs
                    </div>
                </div>
            </div>
        `;

        // Render dispatcher performance
        if (data.dispatchers && data.dispatchers.length > 0) {
            document.getElementById('dispatcher-container').innerHTML = `
                <div class="px-6 py-4 border-b border-dark-border">
                    <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Performance</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-dark-border">
                        <thead class="bg-dark-bg">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dispatcher</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Today</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">This Week</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">This Month</th>
                            </tr>
                        </thead>
                        <tbody class="bg-dark-card divide-y divide-dark-border">
                            ${data.dispatchers.map(d => `
                                <tr class="hover:bg-dark-card-hover">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <span class="font-medium text-christmas-cream">${d.dispatcher_name}</span>
                                            ${d.is_primary ? '<span class="ml-2 px-2 py-1 text-xs bg-christmas-green/20 text-christmas-green-light rounded-full">Primary</span>' : ''}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-center text-christmas-cream">${d.debriefs_completed_today}</td>
                                    <td class="px-6 py-4 text-center text-christmas-cream">${d.debriefs_completed_this_week}</td>
                                    <td class="px-6 py-4 text-center text-christmas-cream">${d.debriefs_completed_this_month}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } else {
            document.getElementById('dispatcher-container').innerHTML = `
                <div class="px-6 py-4 border-b border-dark-border">
                    <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Performance</h2>
                </div>
                <div class="p-6 text-center text-gray-500">
                    <p>No dispatchers configured.</p>
                    <button onclick="setupDispatchers()" class="mt-4 bg-christmas-green hover:bg-christmas-green-dark text-christmas-cream px-4 py-2 rounded transition">
                        Setup Default Dispatchers
                    </button>
                </div>
            `;
        }

        // Render pending jobs
        if (data.pending_jobs && data.pending_jobs.length > 0) {
            document.getElementById('pending-container').innerHTML = `
                <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-christmas-cream">Pending Debriefs (${data.pending_jobs.length})</h2>
                    <a href="/queue" class="text-christmas-green-light hover:text-christmas-green text-sm">View All â†’</a>
                </div>
                <div class="divide-y divide-dark-border">
                    ${data.pending_jobs.slice(0, 5).map(job => `
                        <a href="/debrief/${job.job_id}" class="block px-6 py-3 hover:bg-dark-card-hover transition">
                            <div class="flex justify-between">
                                <div>
                                    <span class="font-medium text-christmas-cream">Job #${job.job_number}</span>
                                    <span class="text-gray-500 ml-2">${job.customer_name}</span>
                                </div>
                                <span class="text-gray-500">${job.tech_name}</span>
                            </div>
                        </a>
                    `).join('')}
                </div>
            `;
        } else {
            document.getElementById('pending-container').innerHTML = `
                <div class="px-6 py-4 border-b border-dark-border">
                    <h2 class="text-lg font-semibold text-christmas-cream">Pending Debriefs</h2>
                </div>
                <div class="p-6 text-center text-gray-500">
                    <div class="text-4xl mb-2">ðŸŽ„</div>
                    All caught up! No pending debriefs.
                </div>
            `;
        }

    } catch (error) {
        console.error('Failed to load dashboard:', error);
    }
}

async function setupDispatchers() {
    try {
        await fetch('/api/dispatchers/setup', { method: 'POST' });
        location.reload();
    } catch (error) {
        console.error('Failed to setup dispatchers:', error);
    }
}

// Load on page load
loadDashboard();
loadTechnicianStats();

// Refresh every 60 seconds
setInterval(() => {
    loadDashboard();
    loadTechnicianStats();
}, 60000);
</script>
{% endblock %}
