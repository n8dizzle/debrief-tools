{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header Row: Title + Global Date Picker -->
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-christmas-cream">Dashboard</h1>
        <!-- Global Date Picker -->
        <div id="date-picker-wrapper" class="relative">
            <button id="date-picker-trigger" onclick="toggleDatePicker()"
                class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-dark-card border border-dark-border text-christmas-cream hover:border-gray-500 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span id="date-picker-label">Last Month</span>
                <svg id="date-picker-chevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
            <div id="date-picker-dropdown" class="hidden absolute right-0 top-full mt-2 w-72 rounded-lg shadow-xl z-50 bg-dark-card border border-dark-border">
                <!-- Presets -->
                <div class="p-2 border-b border-dark-border">
                    <div class="grid grid-cols-2 gap-1" id="date-presets">
                        <button onclick="selectPreset('last-month')" data-preset="last-month" class="preset-btn px-3 py-2 text-sm rounded-md text-left bg-christmas-green text-white">Last Month</button>
                        <button onclick="selectPreset('this-month')" data-preset="this-month" class="preset-btn px-3 py-2 text-sm rounded-md text-left text-gray-300 hover:bg-white/5">This Month</button>
                        <button onclick="selectPreset('last-week')" data-preset="last-week" class="preset-btn px-3 py-2 text-sm rounded-md text-left text-gray-300 hover:bg-white/5">Last Week</button>
                        <button onclick="selectPreset('week-to-date')" data-preset="week-to-date" class="preset-btn px-3 py-2 text-sm rounded-md text-left text-gray-300 hover:bg-white/5">Week to Date</button>
                        <button onclick="selectPreset('month-to-date')" data-preset="month-to-date" class="preset-btn px-3 py-2 text-sm rounded-md text-left text-gray-300 hover:bg-white/5">Month to Date</button>
                        <button onclick="selectPreset('quarter-to-date')" data-preset="quarter-to-date" class="preset-btn px-3 py-2 text-sm rounded-md text-left text-gray-300 hover:bg-white/5">Quarter to Date</button>
                        <button onclick="selectPreset('last-quarter')" data-preset="last-quarter" class="preset-btn px-3 py-2 text-sm rounded-md text-left text-gray-300 hover:bg-white/5">Last Quarter</button>
                        <button onclick="selectPreset('year-to-date')" data-preset="year-to-date" class="preset-btn px-3 py-2 text-sm rounded-md text-left text-gray-300 hover:bg-white/5">Year to Date</button>
                        <button onclick="selectPreset('yesterday')" data-preset="yesterday" class="preset-btn px-3 py-2 text-sm rounded-md text-left text-gray-300 hover:bg-white/5">Yesterday</button>
                        <button onclick="selectPreset('today')" data-preset="today" class="preset-btn px-3 py-2 text-sm rounded-md text-left text-gray-300 hover:bg-white/5">Today</button>
                    </div>
                </div>
                <!-- Custom Range -->
                <div class="p-3">
                    <div class="text-xs font-medium uppercase tracking-wide mb-2 text-gray-500">Custom Range</div>
                    <div class="flex gap-2 mb-3">
                        <div class="flex-1">
                            <label class="text-xs mb-1 block text-gray-500">Start</label>
                            <input type="date" id="custom-date-from"
                                class="w-full px-2 py-1.5 rounded text-sm bg-dark-bg border border-dark-border text-christmas-cream">
                        </div>
                        <div class="flex-1">
                            <label class="text-xs mb-1 block text-gray-500">End</label>
                            <input type="date" id="custom-date-to"
                                class="w-full px-2 py-1.5 rounded text-sm bg-dark-bg border border-dark-border text-christmas-cream">
                        </div>
                    </div>
                    <button onclick="applyCustomRange()"
                        class="w-full py-2 rounded-lg text-sm font-medium bg-christmas-green text-christmas-cream hover:bg-christmas-green-dark transition">
                        Apply
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards - Top Row (Today/This Week/This Month — always visible) -->
    <div id="stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-dark-card rounded-lg border border-dark-border p-6 animate-pulse">
            <div class="h-4 bg-dark-border rounded w-1/2 mb-4"></div>
            <div class="h-8 bg-dark-border rounded w-1/4"></div>
        </div>
        <div class="bg-dark-card rounded-lg border border-dark-border p-6 animate-pulse">
            <div class="h-4 bg-dark-border rounded w-1/2 mb-4"></div>
            <div class="h-8 bg-dark-border rounded w-1/4"></div>
        </div>
        <div class="bg-dark-card rounded-lg border border-dark-border p-6 animate-pulse">
            <div class="h-4 bg-dark-border rounded w-1/2 mb-4"></div>
            <div class="h-8 bg-dark-border rounded w-1/4"></div>
        </div>
    </div>

    <!-- Completion by Business Unit (4 consolidated cards) -->
    <div id="bu-completion-container">
        <div class="flex items-center gap-3 mb-4">
            <h2 class="text-lg font-semibold text-christmas-cream">Completion by Business Unit</h2>
            <span id="bu-overall-rate" class="text-sm text-gray-500"></span>
        </div>
        <div id="bu-cards-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-8 bg-dark-border rounded w-1/3 mb-2"></div>
                <div class="h-2 bg-dark-border rounded w-full"></div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-8 bg-dark-border rounded w-1/3 mb-2"></div>
                <div class="h-2 bg-dark-border rounded w-full"></div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-8 bg-dark-border rounded w-1/3 mb-2"></div>
                <div class="h-2 bg-dark-border rounded w-full"></div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-8 bg-dark-border rounded w-1/3 mb-2"></div>
                <div class="h-2 bg-dark-border rounded w-full"></div>
            </div>
        </div>
    </div>

    <!-- Trade Performance Cards - HVAC vs Plumbing -->
    <div id="trade-performance-container">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-christmas-cream">Performance by Trade <span id="trade-date-label" class="text-gray-500 font-normal">(Last Month)</span></h2>
            <div class="text-sm text-gray-500">HVAC vs Plumbing</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-6 bg-dark-border rounded w-1/2 mb-2"></div>
                <div class="h-3 bg-dark-border rounded w-full"></div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-6 bg-dark-border rounded w-1/2 mb-2"></div>
                <div class="h-3 bg-dark-border rounded w-full"></div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-6 bg-dark-border rounded w-1/2 mb-2"></div>
                <div class="h-3 bg-dark-border rounded w-full"></div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-6 bg-dark-border rounded w-1/2 mb-2"></div>
                <div class="h-3 bg-dark-border rounded w-full"></div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-6 bg-dark-border rounded w-1/2 mb-2"></div>
                <div class="h-3 bg-dark-border rounded w-full"></div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-4 animate-pulse">
                <div class="h-4 bg-dark-border rounded w-2/3 mb-3"></div>
                <div class="h-6 bg-dark-border rounded w-1/2 mb-2"></div>
                <div class="h-3 bg-dark-border rounded w-full"></div>
            </div>
        </div>
    </div>

    <!-- Dispatcher Performance -->
    <div id="dispatcher-container" class="bg-dark-card rounded-lg border border-dark-border">
        <div class="px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Performance</h2>
        </div>
        <div class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-dark-border rounded w-3/4"></div>
                <div class="h-4 bg-dark-border rounded w-1/2"></div>
            </div>
        </div>
    </div>

    <!-- Dispatcher Accuracy (Spot Checks) -->
    <div id="accuracy-container" class="bg-dark-card rounded-lg border border-dark-border">
        <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
            <div>
                <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Accuracy</h2>
                <p class="text-sm text-gray-500 mt-1">Based on spot check reviews</p>
            </div>
            <a href="/spot-checks" class="px-3 py-1.5 text-sm text-christmas-gold hover:text-christmas-cream transition">
                View Spot Checks →
            </a>
        </div>
        <div class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-dark-border rounded w-3/4"></div>
                <div class="h-4 bg-dark-border rounded w-1/2"></div>
            </div>
        </div>
    </div>

    <!-- Technician Performance -->
    <div id="technician-container" class="bg-dark-card rounded-lg border border-dark-border">
        <div class="px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-christmas-cream">Technician Performance</h2>
        </div>
        <div class="p-6">
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-dark-border rounded w-3/4"></div>
                <div class="h-4 bg-dark-border rounded w-1/2"></div>
            </div>
        </div>
    </div>

    <!-- Score Formula -->
    <div class="bg-dark-card rounded-lg border border-dark-border p-6">
        <h2 class="text-lg font-semibold text-christmas-cream mb-4">Composite Score Breakdown</h2>
        <p class="text-sm text-gray-500 mb-4">Hover over each item to see the grading criteria</p>
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
            <div class="text-center p-3 rounded-lg bg-christmas-brown/10 border border-christmas-brown/30 cursor-help group relative">
                <div class="text-2xl font-bold text-christmas-brown">20%</div>
                <div class="text-sm text-gray-400 mt-1">Photos</div>
                <div class="text-xs text-christmas-gold mt-1">Critical</div>
                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-64 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                    <div class="font-semibold text-christmas-cream mb-1">Photos Reviewed</div>
                    <div class="text-gray-400">
                        <span class="text-christmas-green-light">Pass:</span> Before/after photos uploaded showing work performed<br>
                        <span class="text-christmas-brown">Fail:</span> No photos or missing key documentation<br>
                        <span class="text-gray-500">N/A:</span> Remote diagnostic or phone consultation only
                    </div>
                </div>
            </div>
            <div class="text-center p-3 rounded-lg bg-christmas-brown/10 border border-christmas-brown/30 cursor-help group relative">
                <div class="text-2xl font-bold text-christmas-brown">20%</div>
                <div class="text-sm text-gray-400 mt-1">Payment</div>
                <div class="text-xs text-christmas-gold mt-1">Critical</div>
                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-64 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                    <div class="font-semibold text-christmas-cream mb-1">Payment Verified</div>
                    <div class="text-gray-400">
                        <span class="text-christmas-green-light">Pass:</span> Paid in full OR financing set up with proper notes in ST<br>
                        <span class="text-christmas-brown">Fail:</span> Unpaid without valid reason documented<br>
                        <span class="text-gray-500">N/A:</span> Warranty work, no-charge visit, or pre-approved billing
                    </div>
                </div>
            </div>
            <div class="text-center p-3 rounded-lg bg-christmas-brown/10 border border-christmas-brown/30 cursor-help group relative">
                <div class="text-2xl font-bold text-christmas-brown">20%</div>
                <div class="text-sm text-gray-400 mt-1">Estimates</div>
                <div class="text-xs text-christmas-gold mt-1">Critical</div>
                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-64 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                    <div class="font-semibold text-christmas-cream mb-1">Estimates Offered</div>
                    <div class="text-gray-400">
                        <span class="text-christmas-green-light">Pass:</span> Estimate created for repairs, replacements, or add-ons<br>
                        <span class="text-christmas-brown">Fail:</span> Opportunity job with no estimates presented<br>
                        <span class="text-gray-500">N/A:</span> Simple maintenance, warranty, or no upsell opportunity
                    </div>
                </div>
            </div>
            <div class="text-center p-3 rounded-lg bg-christmas-brown/10 border border-christmas-brown/30 cursor-help group relative">
                <div class="text-2xl font-bold text-christmas-brown">20%</div>
                <div class="text-sm text-gray-400 mt-1">Invoice</div>
                <div class="text-xs text-christmas-gold mt-1">Critical</div>
                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-64 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                    <div class="font-semibold text-christmas-cream mb-1">Invoice Summary (1-10)</div>
                    <div class="text-gray-400">
                        <span class="text-christmas-green-light">8-10:</span> Clear, complete summary with diagnosis, work done, and recommendations<br>
                        <span class="text-christmas-gold">5-7:</span> Adequate but missing some details<br>
                        <span class="text-christmas-brown">1-4:</span> Incomplete, vague, or unprofessional
                    </div>
                </div>
            </div>
            <div class="text-center p-3 rounded-lg bg-dark-bg border border-dark-border cursor-help group relative">
                <div class="text-2xl font-bold text-gray-400">10%</div>
                <div class="text-sm text-gray-400 mt-1">Membership</div>
                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-64 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                    <div class="font-semibold text-christmas-cream mb-1">Membership Offered</div>
                    <div class="text-gray-400">
                        <span class="text-christmas-green-light">Pass:</span> Maintenance plan offered and discussed with customer<br>
                        <span class="text-christmas-brown">Fail:</span> Not offered when customer was eligible<br>
                        <span class="text-gray-500">N/A:</span> Customer already has active membership
                    </div>
                </div>
            </div>
            <div class="text-center p-3 rounded-lg bg-dark-bg border border-dark-border cursor-help group relative">
                <div class="text-2xl font-bold text-gray-400">10%</div>
                <div class="text-sm text-gray-400 mt-1">Reviews</div>
                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-64 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                    <div class="font-semibold text-christmas-cream mb-1">Google Reviews Discussed</div>
                    <div class="text-gray-400">
                        <span class="text-christmas-green-light">Pass:</span> Tech asked customer to leave a Google review<br>
                        <span class="text-christmas-brown">Fail:</span> Not mentioned to satisfied customer<br>
                        <span class="text-gray-500">N/A:</span> Customer was unhappy or situation not appropriate
                    </div>
                </div>
            </div>
        </div>
        <p class="text-xs text-gray-500 mt-4 text-center">
            Score = (Photos × 20%) + (Payment × 20%) + (Estimates × 20%) + (Invoice × 20%) + (Membership × 10%) + (Reviews × 10%)
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ===== Global Date Picker State =====
let globalDateFrom = '';
let globalDateTo = '';
let globalPreset = 'last-month';
let datePickerOpen = false;

const PRESET_LABELS = {
    'last-month': 'Last Month',
    'this-month': 'This Month',
    'last-week': 'Last Week',
    'week-to-date': 'Week to Date',
    'month-to-date': 'Month to Date',
    'quarter-to-date': 'Quarter to Date',
    'last-quarter': 'Last Quarter',
    'year-to-date': 'Year to Date',
    'yesterday': 'Yesterday',
    'today': 'Today',
    'custom': 'Custom Range',
};

function formatLocalDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function formatDisplayDate(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function getPresetRange(preset) {
    const now = new Date();
    let from, to;

    switch (preset) {
        case 'last-month':
            to = new Date(now.getFullYear(), now.getMonth(), 0);
            from = new Date(to.getFullYear(), to.getMonth(), 1);
            break;
        case 'this-month':
            from = new Date(now.getFullYear(), now.getMonth(), 1);
            to = now;
            break;
        case 'last-week': {
            const dayOfWeek = now.getDay();
            const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            to = new Date(now);
            to.setDate(now.getDate() - diff - 1); // Last Sunday
            from = new Date(to);
            from.setDate(to.getDate() - 6); // Previous Monday
            break;
        }
        case 'week-to-date': {
            const dow = now.getDay();
            from = new Date(now);
            from.setDate(now.getDate() - (dow === 0 ? 6 : dow - 1));
            to = now;
            break;
        }
        case 'month-to-date':
            from = new Date(now.getFullYear(), now.getMonth(), 1);
            to = now;
            break;
        case 'quarter-to-date': {
            const quarter = Math.floor(now.getMonth() / 3);
            from = new Date(now.getFullYear(), quarter * 3, 1);
            to = now;
            break;
        }
        case 'last-quarter': {
            const q = Math.floor(now.getMonth() / 3);
            from = new Date(now.getFullYear(), (q - 1) * 3, 1);
            to = new Date(now.getFullYear(), q * 3, 0);
            break;
        }
        case 'year-to-date':
            from = new Date(now.getFullYear(), 0, 1);
            to = now;
            break;
        case 'yesterday': {
            const y = new Date(now);
            y.setDate(now.getDate() - 1);
            from = y;
            to = y;
            break;
        }
        case 'today':
            from = now;
            to = now;
            break;
        default:
            from = now;
            to = now;
    }

    return { from: formatLocalDate(from), to: formatLocalDate(to) };
}

function toggleDatePicker() {
    datePickerOpen = !datePickerOpen;
    document.getElementById('date-picker-dropdown').classList.toggle('hidden', !datePickerOpen);
    document.getElementById('date-picker-chevron').style.transform = datePickerOpen ? 'rotate(180deg)' : '';
}

function closeDatePicker() {
    datePickerOpen = false;
    document.getElementById('date-picker-dropdown').classList.add('hidden');
    document.getElementById('date-picker-chevron').style.transform = '';
}

function updatePresetButtons() {
    document.querySelectorAll('.preset-btn').forEach(btn => {
        const p = btn.getAttribute('data-preset');
        if (p === globalPreset) {
            btn.className = 'preset-btn px-3 py-2 text-sm rounded-md text-left bg-christmas-green text-white';
        } else {
            btn.className = 'preset-btn px-3 py-2 text-sm rounded-md text-left text-gray-300 hover:bg-white/5';
        }
    });
}

function updateDateLabel() {
    const label = document.getElementById('date-picker-label');
    if (globalPreset === 'custom') {
        label.textContent = `${formatDisplayDate(globalDateFrom)} - ${formatDisplayDate(globalDateTo)}`;
    } else {
        label.textContent = PRESET_LABELS[globalPreset] || globalPreset;
    }
}

function selectPreset(preset) {
    globalPreset = preset;
    const range = getPresetRange(preset);
    globalDateFrom = range.from;
    globalDateTo = range.to;
    updatePresetButtons();
    updateDateLabel();
    closeDatePicker();
    onGlobalDateChange();
}

function applyCustomRange() {
    const from = document.getElementById('custom-date-from').value;
    const to = document.getElementById('custom-date-to').value;
    if (!from || !to) return;
    globalPreset = 'custom';
    globalDateFrom = from;
    globalDateTo = to;
    updatePresetButtons();
    updateDateLabel();
    closeDatePicker();
    onGlobalDateChange();
}

// Click outside to close
document.addEventListener('mousedown', function(e) {
    const wrapper = document.getElementById('date-picker-wrapper');
    if (wrapper && !wrapper.contains(e.target)) {
        closeDatePicker();
    }
});

// ===== When global date changes, reload all date-dependent sections =====
function onGlobalDateChange() {
    loadBUCompletion();
    loadTechnicianStats();
    loadTradePerformance();
}


// ===== Helper functions =====
function getMetricColor(value, threshold = 80) {
    if (value === null || value === undefined) return 'text-gray-500';
    if (value >= threshold) return 'text-christmas-green-light';
    if (value >= 50) return 'text-christmas-gold';
    return 'text-christmas-brown';
}

function formatMetric(value) {
    if (value === null || value === undefined) return '--';
    return `${Math.round(value)}%`;
}

function getBUCompletionColor(rate) {
    if (rate >= 100) return 'text-christmas-green-light';
    if (rate >= 80) return 'text-christmas-gold';
    return 'text-christmas-brown';
}

function getBUBarColor(rate) {
    if (rate >= 100) return 'bg-christmas-green';
    if (rate >= 80) return 'bg-christmas-gold';
    return 'bg-christmas-brown';
}


// ===== BU Completion (consolidated 4 cards) =====
async function loadBUCompletion() {
    try {
        const response = await fetch(`/api/dashboard/completion-by-bu?date_from=${globalDateFrom}&date_to=${globalDateTo}`);
        const data = await response.json();

        // Update overall rate
        const overall = data.overall;
        document.getElementById('bu-overall-rate').innerHTML = overall.total_jobs > 0
            ? `<span class="${getBUCompletionColor(overall.completion_rate)} font-semibold">${overall.completion_rate}%</span> overall (${overall.debriefed_jobs}/${overall.total_jobs})`
            : '';

        if (!data.business_units || data.business_units.length === 0) {
            document.getElementById('bu-cards-grid').innerHTML = `
                <div class="col-span-full bg-dark-card rounded-lg border border-dark-border p-8 text-center text-gray-500">
                    No completed jobs found for this date range.
                </div>
            `;
            return;
        }

        // Aggregate into 4 groups
        const groups = {
            'HVAC Install': { debriefed: 0, total: 0 },
            'HVAC Maintenance': { debriefed: 0, total: 0 },
            'HVAC Service': { debriefed: 0, total: 0 },
            'Plumbing': { debriefed: 0, total: 0 },
        };

        for (const bu of data.business_units) {
            const name = (bu.name || '').toLowerCase();
            const trade = bu.trade_type || '';

            if (trade === 'Plumbing') {
                groups['Plumbing'].debriefed += bu.debriefed_jobs;
                groups['Plumbing'].total += bu.total_jobs;
            } else if (trade === 'HVAC') {
                if (name.includes('install')) {
                    groups['HVAC Install'].debriefed += bu.debriefed_jobs;
                    groups['HVAC Install'].total += bu.total_jobs;
                } else if (name.includes('maintenance')) {
                    groups['HVAC Maintenance'].debriefed += bu.debriefed_jobs;
                    groups['HVAC Maintenance'].total += bu.total_jobs;
                } else {
                    // Default: Service (includes "Service", "Commercial Service", etc.)
                    groups['HVAC Service'].debriefed += bu.debriefed_jobs;
                    groups['HVAC Service'].total += bu.total_jobs;
                }
            } else {
                // Unknown trade — put in Service as fallback
                groups['HVAC Service'].debriefed += bu.debriefed_jobs;
                groups['HVAC Service'].total += bu.total_jobs;
            }
        }

        // Render 4 cards
        let html = '';
        const cardOrder = ['HVAC Install', 'HVAC Service', 'HVAC Maintenance', 'Plumbing'];
        const cardColors = {
            'HVAC Install': 'border-l-christmas-green',
            'HVAC Service': 'border-l-christmas-green',
            'HVAC Maintenance': 'border-l-christmas-green',
            'Plumbing': 'border-l-blue-500',
        };

        for (const label of cardOrder) {
            const g = groups[label];
            if (g.total === 0) {
                html += `
                    <div class="bg-dark-card rounded-lg border border-dark-border border-l-4 ${cardColors[label]} p-4">
                        <div class="text-sm font-medium text-christmas-cream mb-2">${label}</div>
                        <div class="text-3xl font-bold text-gray-500 mb-1">--</div>
                        <div class="w-full h-2 bg-dark-bg rounded-full overflow-hidden mb-2">
                            <div class="h-full bg-gray-600" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-gray-500">No jobs</div>
                    </div>
                `;
                continue;
            }
            const rate = Math.round(g.debriefed / g.total * 1000) / 10;
            html += `
                <div class="bg-dark-card rounded-lg border border-dark-border border-l-4 ${cardColors[label]} p-4">
                    <div class="text-sm font-medium text-christmas-cream mb-2">${label}</div>
                    <div class="text-3xl font-bold ${getBUCompletionColor(rate)} mb-1">${rate}%</div>
                    <div class="w-full h-2 bg-dark-bg rounded-full overflow-hidden mb-2">
                        <div class="h-full ${getBUBarColor(rate)} transition-all duration-500" style="width: ${Math.min(rate, 100)}%"></div>
                    </div>
                    <div class="text-xs text-gray-500">${g.debriefed} / ${g.total} debriefed</div>
                </div>
            `;
        }

        document.getElementById('bu-cards-grid').innerHTML = html;
    } catch (error) {
        console.error('Failed to load BU completion:', error);
        document.getElementById('bu-cards-grid').innerHTML = `
            <div class="col-span-full bg-dark-card rounded-lg border border-dark-border p-8 text-center text-christmas-brown">
                Failed to load completion data.
            </div>
        `;
    }
}


// ===== Trade Performance =====
function renderTradePerformanceCard(title, icon, hvacValue, plumbingValue, isScore = false) {
    const hvacDisplay = isScore ? (hvacValue || 0).toFixed(1) : `${hvacValue || 0}%`;
    const plumbingDisplay = isScore ? (plumbingValue || 0).toFixed(1) : `${plumbingValue || 0}%`;
    const hvacPct = isScore ? (hvacValue || 0) * 10 : (hvacValue || 0);
    const plumbingPct = isScore ? (plumbingValue || 0) * 10 : (plumbingValue || 0);
    const hvacWins = hvacPct > plumbingPct;
    const plumbingWins = plumbingPct > hvacPct;
    const tie = hvacPct === plumbingPct;

    return `
        <div class="bg-dark-card rounded-lg border border-dark-border p-4">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-lg">${icon}</span>
                <span class="text-sm font-medium text-christmas-cream">${title}</span>
            </div>
            <div class="space-y-3">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500 w-12">HVAC</span>
                    <div class="flex-1 h-2 bg-dark-bg rounded-full overflow-hidden">
                        <div class="h-full ${hvacWins ? 'bg-christmas-green' : 'bg-gray-600'} transition-all duration-500" style="width: ${hvacPct}%"></div>
                    </div>
                    <span class="text-sm font-bold ${hvacWins ? 'text-christmas-green-light' : 'text-gray-400'} w-12 text-right">${hvacDisplay}</span>
                    ${hvacWins && !tie ? '<span class="text-yellow-500">&#x1F3C6;</span>' : '<span class="w-5"></span>'}
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500 w-12">Plumb</span>
                    <div class="flex-1 h-2 bg-dark-bg rounded-full overflow-hidden">
                        <div class="h-full ${plumbingWins ? 'bg-blue-500' : 'bg-gray-600'} transition-all duration-500" style="width: ${plumbingPct}%"></div>
                    </div>
                    <span class="text-sm font-bold ${plumbingWins ? 'text-blue-400' : 'text-gray-400'} w-12 text-right">${plumbingDisplay}</span>
                    ${plumbingWins && !tie ? '<span class="text-yellow-500">&#x1F3C6;</span>' : '<span class="w-5"></span>'}
                </div>
            </div>
        </div>
    `;
}

async function loadTradePerformance() {
    const dateLabel = PRESET_LABELS[globalPreset] || `${formatDisplayDate(globalDateFrom)} - ${formatDisplayDate(globalDateTo)}`;
    document.getElementById('trade-date-label').textContent = `(${dateLabel})`;

    try {
        const response = await fetch(`/api/dashboard/trade-performance?date_from=${globalDateFrom}&date_to=${globalDateTo}`);
        const tradePerformance = await response.json();

        if (!tradePerformance || (!tradePerformance.hvac && !tradePerformance.plumbing)) {
            document.getElementById('trade-performance-container').innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-christmas-cream">Performance by Trade <span class="text-gray-500 font-normal">(${dateLabel})</span></h2>
                    <div class="text-sm text-gray-500">HVAC vs Plumbing</div>
                </div>
                <div class="bg-dark-card rounded-lg border border-dark-border p-8 text-center text-gray-500">
                    No debrief data available for this period.
                </div>
            `;
            return;
        }

        const hvac = tradePerformance.hvac || {};
        const plumbing = tradePerformance.plumbing || {};

        document.getElementById('trade-performance-container').innerHTML = `
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-christmas-cream">Performance by Trade <span id="trade-date-label" class="text-gray-500 font-normal">(${dateLabel})</span></h2>
                <div class="flex items-center gap-4 text-sm">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-christmas-green rounded"></span> HVAC (${hvac.total_debriefed || 0} jobs)</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-500 rounded"></span> Plumbing (${plumbing.total_debriefed || 0} jobs)</span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                ${renderTradePerformanceCard('Photos', '&#x1F4F7;', hvac.photos_pass_rate, plumbing.photos_pass_rate)}
                ${renderTradePerformanceCard('Payment', '&#x1F4B5;', hvac.payment_pass_rate, plumbing.payment_pass_rate)}
                ${renderTradePerformanceCard('Estimates', '&#x1F4CB;', hvac.estimates_pass_rate, plumbing.estimates_pass_rate)}
                ${renderTradePerformanceCard('Invoice Score', '&#x1F4DD;', hvac.avg_invoice_score, plumbing.avg_invoice_score, true)}
                ${renderTradePerformanceCard('Equipment Added', '&#x1F527;', hvac.equipment_added_rate, plumbing.equipment_added_rate)}
                ${renderTradePerformanceCard('Materials', '&#x1F4B0;', hvac.materials_on_invoice_rate, plumbing.materials_on_invoice_rate)}
            </div>
        `;
    } catch (error) {
        console.error('Failed to load trade performance:', error);
    }
}


// ===== Technician Performance (uses global date picker) =====
let technicianData = null;

function renderTechnicianTable(data) {
    const dateLabel = PRESET_LABELS[globalPreset] || `${formatDisplayDate(globalDateFrom)} - ${formatDisplayDate(globalDateTo)}`;

    if (!data || data.length === 0) {
        document.getElementById('technician-container').innerHTML = `
            <div class="px-6 py-4 border-b border-dark-border">
                <h2 class="text-lg font-semibold text-christmas-cream">Technician Performance <span class="text-gray-500 font-normal text-base">&mdash; ${dateLabel}</span></h2>
            </div>
            <div class="p-6 text-center text-gray-500">
                No technician data available for this period.
            </div>
        `;
        return;
    }

    document.getElementById('technician-container').innerHTML = `
        <div class="px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-christmas-cream">Technician Performance <span class="text-gray-500 font-normal text-base">&mdash; ${dateLabel}</span></h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-dark-border">
                <thead class="bg-dark-bg">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Technician</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="Total number of jobs debriefed by this technician.">
                            <span class="cursor-help">Jobs</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-christmas-green uppercase bg-christmas-green/10" title="Overall performance score (0-100).">
                            <span class="cursor-help">Score</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="Average invoice summary quality rating (1-10).">
                            <span class="cursor-help">Invoice</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-christmas-brown uppercase bg-christmas-brown/10" title="CRITICAL: Percentage of jobs with proper before/after photos.">
                            <span class="cursor-help">Photos</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-christmas-brown uppercase bg-christmas-brown/10" title="CRITICAL: Percentage of jobs where payment was collected.">
                            <span class="cursor-help">Payment</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-christmas-brown uppercase bg-christmas-brown/10" title="CRITICAL: Percentage of jobs where estimates were offered.">
                            <span class="cursor-help">Estimates</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="Percentage of jobs where membership was offered.">
                            <span class="cursor-help">Membership</span>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="Percentage of jobs where a Google review was requested.">
                            <span class="cursor-help">Reviews</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-dark-card divide-y divide-dark-border">
                    ${data.map(t => `
                        <tr class="hover:bg-dark-card-hover">
                            <td class="px-4 py-3 whitespace-nowrap">
                                <a href="/history?tech=${encodeURIComponent(t.tech_name)}" class="font-medium text-christmas-cream hover:text-christmas-gold hover:underline transition">${t.tech_name}</a>
                            </td>
                            <td class="px-4 py-3 text-center text-gray-400">${t.jobs_debriefed}</td>
                            <td class="px-4 py-3 text-center bg-christmas-green/10">
                                <span class="${t.composite_score >= 80 ? 'text-christmas-green-light' : t.composite_score >= 60 ? 'text-christmas-gold' : 'text-christmas-brown'} font-bold text-lg">
                                    ${t.composite_score}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="${t.avg_invoice_score >= 7 ? 'text-christmas-green-light' : t.avg_invoice_score >= 5 ? 'text-christmas-gold' : 'text-christmas-brown'} font-medium">
                                    ${t.avg_invoice_score !== null ? t.avg_invoice_score.toFixed(1) : '--'}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center bg-christmas-brown/10">
                                <span class="${getMetricColor(t.photos_pass_rate)} font-semibold">${formatMetric(t.photos_pass_rate)}</span>
                            </td>
                            <td class="px-4 py-3 text-center bg-christmas-brown/10">
                                <span class="${getMetricColor(t.payment_pass_rate)} font-semibold">${formatMetric(t.payment_pass_rate)}</span>
                            </td>
                            <td class="px-4 py-3 text-center bg-christmas-brown/10">
                                <span class="${getMetricColor(t.estimates_pass_rate)} font-semibold">${formatMetric(t.estimates_pass_rate)}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="${getMetricColor(t.membership_pass_rate, 50)}">${formatMetric(t.membership_pass_rate)}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="${getMetricColor(t.google_reviews_pass_rate, 50)}">${formatMetric(t.google_reviews_pass_rate)}</span>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <div class="px-4 py-3 bg-dark-bg text-xs text-gray-500 border-t border-dark-border flex items-center gap-4">
            <span><span class="inline-block px-2 py-1 bg-christmas-green/20 text-christmas-green-light rounded font-medium">Score</span> = Weighted composite (Photos, Payment, Estimates, Invoice = 2x weight)</span>
            <span><span class="inline-block px-2 py-1 bg-christmas-brown/20 text-christmas-brown rounded">Critical</span> = High priority metrics</span>
        </div>
    `;
}

async function loadTechnicianStats() {
    try {
        const response = await fetch(`/api/technician-stats?date_from=${globalDateFrom}&date_to=${globalDateTo}`);
        technicianData = await response.json();
        renderTechnicianTable(technicianData);
    } catch (error) {
        console.error('Failed to load technician stats:', error);
        document.getElementById('technician-container').innerHTML = `
            <div class="px-6 py-4 border-b border-dark-border">
                <h2 class="text-lg font-semibold text-christmas-cream">Technician Performance</h2>
            </div>
            <div class="p-6 text-center text-christmas-brown">
                Failed to load technician data.
            </div>
        `;
    }
}


// ===== Dashboard Stats (Today/This Week/This Month — independent of date picker) =====
async function loadDashboard() {
    try {
        const response = await fetch('/api/dashboard');
        const data = await response.json();

        // Render stats
        document.getElementById('stats-container').innerHTML = `
            <div class="bg-dark-card rounded-lg border border-dark-border p-6">
                <div class="text-sm font-medium text-gray-500">Today</div>
                <div class="mt-2 flex items-baseline justify-between">
                    <div class="text-3xl font-bold ${data.today.completion_rate >= 100 ? 'text-christmas-green-light' : 'text-christmas-gold'}">
                        ${data.today.completion_rate}%
                    </div>
                    <div class="text-sm text-gray-500">
                        ${data.today.total_debriefed} / ${data.today.total_completed_jobs} jobs
                    </div>
                </div>
                <div class="mt-2 text-sm text-gray-500">
                    ${data.today.pending_debrief} pending
                </div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-6">
                <div class="text-sm font-medium text-gray-500">This Week</div>
                <div class="mt-2 flex items-baseline justify-between">
                    <div class="text-3xl font-bold ${data.this_week.completion_rate >= 100 ? 'text-christmas-green-light' : 'text-christmas-gold'}">
                        ${data.this_week.completion_rate}%
                    </div>
                    <div class="text-sm text-gray-500">
                        ${data.this_week.total_debriefed} / ${data.this_week.total_completed_jobs} jobs
                    </div>
                </div>
            </div>
            <div class="bg-dark-card rounded-lg border border-dark-border p-6">
                <div class="text-sm font-medium text-gray-500">This Month</div>
                <div class="mt-2 flex items-baseline justify-between">
                    <div class="text-3xl font-bold ${data.this_month.completion_rate >= 100 ? 'text-christmas-green-light' : 'text-christmas-gold'}">
                        ${data.this_month.completion_rate}%
                    </div>
                    <div class="text-sm text-gray-500">
                        ${data.this_month.total_debriefed} / ${data.this_month.total_completed_jobs} jobs
                    </div>
                </div>
            </div>
        `;

        // Render dispatcher performance
        if (data.dispatchers && data.dispatchers.length > 0) {
            document.getElementById('dispatcher-container').innerHTML = `
                <div class="px-6 py-4 border-b border-dark-border">
                    <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Performance</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-dark-border">
                        <thead class="bg-dark-bg">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dispatcher</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Today</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">This Week</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">This Month</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-christmas-green uppercase bg-christmas-green/10" title="Happy calls completed (marked as Pass)">Happy Calls</th>
                            </tr>
                        </thead>
                        <tbody class="bg-dark-card divide-y divide-dark-border">
                            ${data.dispatchers.map(d => `
                                <tr class="hover:bg-dark-card-hover">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <span class="font-medium text-christmas-cream">${d.dispatcher_name}</span>
                                            ${d.is_primary ? '<span class="ml-2 px-2 py-1 text-xs bg-christmas-green/20 text-christmas-green-light rounded-full">Primary</span>' : ''}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-center text-christmas-cream">${d.debriefs_completed_today}</td>
                                    <td class="px-6 py-4 text-center text-christmas-cream">${d.debriefs_completed_this_week}</td>
                                    <td class="px-6 py-4 text-center text-christmas-cream">${d.debriefs_completed_this_month}</td>
                                    <td class="px-6 py-4 text-center bg-christmas-green/10">
                                        <span class="text-christmas-green-light font-semibold">${d.happy_calls_this_month || 0}</span>
                                        <span class="text-xs text-gray-500 ml-1">/ ${d.debriefs_completed_this_month}</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } else {
            document.getElementById('dispatcher-container').innerHTML = `
                <div class="px-6 py-4 border-b border-dark-border">
                    <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Performance</h2>
                </div>
                <div class="p-6 text-center text-gray-500">
                    <p>No dispatchers configured.</p>
                    <button onclick="setupDispatchers()" class="mt-4 bg-christmas-green hover:bg-christmas-green-dark text-christmas-cream px-4 py-2 rounded transition">
                        Setup Default Dispatchers
                    </button>
                </div>
            `;
        }

    } catch (error) {
        console.error('Failed to load dashboard:', error);
    }
}

async function setupDispatchers() {
    try {
        await fetch('/api/dispatchers/setup', { method: 'POST' });
        location.reload();
    } catch (error) {
        console.error('Failed to setup dispatchers:', error);
    }
}


// ===== Dispatcher Accuracy =====
async function loadDispatcherAccuracy() {
    try {
        const response = await fetch('/api/spot-checks/dispatcher-stats');
        const stats = await response.json();

        if (!stats || stats.length === 0) {
            document.getElementById('accuracy-container').innerHTML = `
                <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Accuracy</h2>
                        <p class="text-sm text-gray-500 mt-1">Based on spot check reviews</p>
                    </div>
                    <a href="/spot-checks" class="px-3 py-1.5 text-sm text-christmas-gold hover:text-christmas-cream transition">
                        View Spot Checks →
                    </a>
                </div>
                <div class="p-6 text-center text-gray-500">
                    No spot check data available yet. Complete spot checks to see dispatcher accuracy.
                </div>
            `;
            return;
        }

        const withData = stats.filter(s => s.sample_size > 0);

        if (withData.length === 0) {
            document.getElementById('accuracy-container').innerHTML = `
                <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Accuracy</h2>
                        <p class="text-sm text-gray-500 mt-1">Based on spot check reviews</p>
                    </div>
                    <a href="/spot-checks" class="px-3 py-1.5 text-sm text-christmas-gold hover:text-christmas-cream transition">
                        View Spot Checks →
                    </a>
                </div>
                <div class="p-6 text-center text-gray-500">
                    No completed spot checks yet. Complete reviews to see accuracy data.
                </div>
            `;
            return;
        }

        document.getElementById('accuracy-container').innerHTML = `
            <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Accuracy</h2>
                    <p class="text-sm text-gray-500 mt-1">Based on spot check reviews</p>
                </div>
                <a href="/spot-checks" class="px-3 py-1.5 text-sm text-christmas-gold hover:text-christmas-cream transition">
                    View Spot Checks →
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-dark-border">
                    <thead class="bg-dark-bg">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dispatcher</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Checked</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-christmas-green uppercase bg-christmas-green/10">Accuracy</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Avg Grade</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Photos</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Invoice</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Payment</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Estimates</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Coaching</th>
                        </tr>
                    </thead>
                    <tbody class="bg-dark-card divide-y divide-dark-border">
                        ${withData.map(d => `
                            <tr class="hover:bg-dark-card-hover">
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <span class="font-medium text-christmas-cream">${d.dispatcher_name}</span>
                                    ${d.is_primary ? '<span class="ml-2 px-1.5 py-0.5 text-xs bg-christmas-green/20 text-christmas-green-light rounded">Primary</span>' : ''}
                                </td>
                                <td class="px-4 py-3 text-center text-gray-400">${d.sample_size}</td>
                                <td class="px-4 py-3 text-center bg-christmas-green/10">
                                    <span class="${d.overall_accuracy >= 90 ? 'text-christmas-green-light' : d.overall_accuracy >= 70 ? 'text-christmas-gold' : 'text-christmas-brown'} font-bold text-lg">
                                        ${d.overall_accuracy !== null ? d.overall_accuracy + '%' : '--'}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="${d.avg_grade >= 8 ? 'text-christmas-green-light' : d.avg_grade >= 6 ? 'text-christmas-gold' : 'text-christmas-brown'} font-medium">
                                        ${d.avg_grade !== null ? d.avg_grade.toFixed(1) : '--'}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="${d.photos_accuracy >= 90 ? 'text-christmas-green-light' : d.photos_accuracy >= 70 ? 'text-christmas-gold' : 'text-christmas-brown'}">
                                        ${d.photos_accuracy !== null ? d.photos_accuracy + '%' : '--'}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="${d.invoice_score_accuracy >= 90 ? 'text-christmas-green-light' : d.invoice_score_accuracy >= 70 ? 'text-christmas-gold' : 'text-christmas-brown'}">
                                        ${d.invoice_score_accuracy !== null ? d.invoice_score_accuracy + '%' : '--'}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="${d.payment_accuracy >= 90 ? 'text-christmas-green-light' : d.payment_accuracy >= 70 ? 'text-christmas-gold' : 'text-christmas-brown'}">
                                        ${d.payment_accuracy !== null ? d.payment_accuracy + '%' : '--'}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="${d.estimates_accuracy >= 90 ? 'text-christmas-green-light' : d.estimates_accuracy >= 70 ? 'text-christmas-gold' : 'text-christmas-brown'}">
                                        ${d.estimates_accuracy !== null ? d.estimates_accuracy + '%' : '--'}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    ${d.coaching_needed_count > 0 ?
                                        `<span class="px-2 py-1 text-xs rounded bg-christmas-gold/20 text-christmas-gold">${d.coaching_needed_count}</span>` :
                                        '<span class="text-gray-500">0</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            <div class="px-4 py-3 bg-dark-bg text-xs text-gray-500 border-t border-dark-border">
                Accuracy = Weighted average of correct items. Green (90%+), Yellow (70-89%), Red (&lt;70%)
            </div>
        `;
    } catch (error) {
        console.error('Failed to load dispatcher accuracy:', error);
        document.getElementById('accuracy-container').innerHTML = `
            <div class="px-6 py-4 border-b border-dark-border">
                <h2 class="text-lg font-semibold text-christmas-cream">Dispatcher Accuracy</h2>
            </div>
            <div class="p-6 text-center text-christmas-brown">
                Failed to load accuracy data.
            </div>
        `;
    }
}


// ===== Initialize =====
// Set default date range (Last Month) and load everything
const defaultRange = getPresetRange('last-month');
globalDateFrom = defaultRange.from;
globalDateTo = defaultRange.to;

loadDashboard();
loadDispatcherAccuracy();
onGlobalDateChange(); // loads BU completion, technician stats, trade performance

// Refresh every 60 seconds
setInterval(() => {
    loadDashboard();
    loadDispatcherAccuracy();
    onGlobalDateChange();
}, 60000);
</script>
{% endblock %}
