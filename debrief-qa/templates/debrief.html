{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Back Button -->
    <a href="/queue" class="inline-flex items-center text-christmas-green-light hover:text-christmas-green mb-4">
        ‚Üê Back to Queue
    </a>

    <!-- Job Header -->
    <div class="bg-dark-card rounded-lg border border-dark-border mb-6">
        <div class="px-6 py-4 border-b border-dark-border">
            <div class="flex justify-between items-start">
                <div>
                    <div class="flex items-center gap-3">
                        <h1 class="text-2xl font-bold text-christmas-cream">Job #{{ ticket.job_number }}</h1>
                        <a href="https://go.servicetitan.com/#/Job/Index/{{ ticket.job_id }}"
                           target="_blank"
                           class="text-sm text-christmas-green-light hover:text-christmas-green hover:underline">
                            View in ServiceTitan ‚Üó
                        </a>
                        {% if debrief %}
                        <!-- Spot Check Button (for completed debriefs) -->
                        {% if spot_check %}
                        <a href="/spot-check/{{ spot_check.id }}"
                           class="px-3 py-1 text-sm bg-christmas-gold/20 text-christmas-gold rounded-lg border border-christmas-gold/50 hover:bg-christmas-gold/30 transition">
                            View Spot Check
                        </a>
                        {% else %}
                        <button onclick="addToSpotCheck({{ debrief.id }})"
                                class="px-3 py-1 text-sm bg-christmas-gold/20 text-christmas-gold rounded-lg border border-christmas-gold/50 hover:bg-christmas-gold/30 transition">
                            + Spot Check
                        </button>
                        {% endif %}
                        {% endif %}
                    </div>
                    <div class="mt-1 flex items-center space-x-3 flex-wrap gap-2">
                        <span class="px-2 py-1 text-sm rounded-full bg-christmas-green/20 text-christmas-green-light">{{ ticket.job_type_name or 'Unknown' }}</span>
                        <span class="px-2 py-1 text-sm rounded-full bg-dark-border text-gray-400">{{ ticket.trade_type or 'Unknown' }}</span>
                        {% if ticket.job_status and ticket.job_status != 'Completed' %}
                        <span class="px-2 py-1 text-sm rounded-full {% if ticket.job_status == 'Canceled' %}bg-christmas-brown/20 text-christmas-brown{% else %}bg-christmas-gold/20 text-christmas-gold{% endif %}">
                            {{ ticket.job_status }}
                        </span>
                        {% endif %}
                        {% if ticket.is_new_customer %}
                        <span class="px-2 py-1 text-sm rounded-full bg-christmas-green/20 text-christmas-green-light">New Customer</span>
                        {% endif %}
                        {% if ticket.is_opportunity %}
                        <span class="px-2 py-1 text-sm rounded-full bg-christmas-gold/20 text-christmas-gold font-semibold" title="This job has a conversion opportunity tag - estimates should be presented">üéØ Opportunity</span>
                        {% endif %}
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-christmas-cream">${{ "{:,.2f}".format(ticket.invoice_total) }}</div>
                    <div class="text-sm {% if ticket.payment_collected %}text-christmas-green-light{% else %}text-christmas-brown font-semibold{% endif %}">
                        {% if ticket.payment_collected %}‚úì Payment Collected{% if ticket.payment_method %} ({{ ticket.payment_method }}){% endif %}{% else %}‚úó Payment Outstanding: ${{ "{:,.2f}".format(ticket.invoice_balance) }}{% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Details Grid -->
        <div class="px-6 py-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
                <div class="text-gray-500">Customer</div>
                <div class="font-medium text-christmas-cream">{{ ticket.customer_name or 'Unknown' }}</div>
            </div>
            <div>
                <div class="text-gray-500">Technician{% if ticket.all_techs and ticket.all_techs|length > 1 %}s{% endif %}</div>
                <div class="font-medium text-christmas-cream">
                    {% if ticket.all_techs and ticket.all_techs|length > 1 %}
                        {% for tech in ticket.all_techs %}{{ tech.name }}{% if not loop.last %}, {% endif %}{% endfor %}
                    {% else %}
                        {{ ticket.tech_name or 'Unassigned' }}
                    {% endif %}
                </div>
            </div>
            <div>
                <div class="text-gray-500">Completed</div>
                <div class="font-medium text-christmas-cream">{{ (ticket.completed_at|central).strftime('%b %d, %I:%M %p') if ticket.completed_at else 'N/A' }}</div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="px-6 py-4 bg-dark-bg rounded-b-lg grid grid-cols-4 gap-4 text-center border-t border-dark-border">
            <div>
                <div class="text-2xl font-bold text-christmas-green-light">{{ ticket.photo_count }}</div>
                <div class="text-xs text-gray-500">Photos</div>
            </div>
            <div>
                <div class="text-2xl font-bold text-christmas-green-light">{{ ticket.form_count or 0 }}</div>
                <div class="text-xs text-gray-500">Forms</div>
            </div>
            <div>
                <div class="text-2xl font-bold text-christmas-gold">{{ ticket.estimate_count }}</div>
                <div class="text-xs text-gray-500">Estimates</div>
            </div>
            <div>
                <div class="text-2xl font-bold {% if ticket.membership_sold %}text-christmas-green-light{% else %}text-gray-500{% endif %}">
                    {% if ticket.membership_sold %}Yes{% else %}No{% endif %}
                </div>
                <div class="text-xs text-gray-500">Membership</div>
            </div>
        </div>
    </div>

    <!-- Invoice Summary Display -->
    {% if ticket.invoice_summary %}
    <div class="bg-dark-card rounded-lg border border-dark-border mb-6">
        <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
            <h2 class="text-lg font-semibold text-christmas-cream">Invoice Summary</h2>
            {% if ticket.invoice_author %}
            <span class="text-sm text-gray-500">Written by: <span class="text-christmas-cream">{{ ticket.invoice_author }}</span></span>
            {% endif %}
        </div>
        <div class="px-6 py-4">
            <div class="bg-dark-bg rounded p-4 text-gray-300 whitespace-pre-wrap border border-dark-border">{{ ticket.invoice_summary }}</div>
        </div>
    </div>
    {% endif %}

    <!-- Forms Completed -->
    {% if form_submissions %}
    <div class="bg-dark-card rounded-lg border border-dark-border mb-6">
        <div class="px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-christmas-cream">Forms Completed ({{ form_submissions|length }})</h2>
        </div>
        <div class="px-6 py-4">
            <div class="space-y-2">
                {% for form in form_submissions %}
                <div class="flex items-center justify-between bg-dark-bg rounded p-3 border border-dark-border">
                    <div class="flex items-center gap-3">
                        <span class="text-christmas-green-light">üìù</span>
                        <span class="text-christmas-cream font-medium">{{ form.formName }}</span>
                        <span class="text-xs text-gray-500">{{ form.submittedOn[:10] if form.submittedOn else '' }}</span>
                    </div>
                    <a href="https://go.servicetitan.com/#/new/forms20/AssignedTo/Job/{{ ticket.job_id }}/Form/{{ form.formId }}/Submission/{{ form.id }}/View"
                       target="_blank"
                       class="text-sm text-christmas-green-light hover:text-christmas-green hover:underline">
                        View in ST ‚Üó
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Completed Debrief Review (if already debriefed) -->
    {% if debrief %}
    <div class="bg-dark-card rounded-lg border border-christmas-green/50 mb-6">
        <div class="px-6 py-4 border-b border-dark-border bg-christmas-green/10">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-semibold text-christmas-cream">‚úì Debrief Completed</h2>
                    <p class="text-sm text-gray-400 mt-1">
                        By {{ debrief.dispatcher.name if debrief.dispatcher else 'Unknown' }} on
                        {{ (debrief.completed_at|central).strftime('%b %d, %Y at %I:%M %p') if debrief.completed_at else 'N/A' }}
                    </p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">Composite Score</div>
                    {% set photos_pass = 1 if debrief.photos_reviewed == 'pass' else 0 %}
                    {% set payment_pass = 1 if debrief.payment_verified == 'pass' else 0 %}
                    {% set estimates_pass = 1 if debrief.estimates_verified == 'pass' else 0 %}
                    {% set membership_pass = 1 if debrief.membership_verified == 'pass' else 0 %}
                    {% set reviews_pass = 1 if debrief.google_reviews_discussed == 'pass' else 0 %}
                    {% set invoice_pct = (debrief.invoice_summary_score or 5) * 10 %}
                    {% set composite = ((photos_pass * 100 * 2) + (payment_pass * 100 * 2) + (estimates_pass * 100 * 2) + (invoice_pct * 2) + (membership_pass * 100 * 1) + (reviews_pass * 100 * 1)) / 10 %}
                    <div class="text-2xl font-bold {% if composite >= 70 %}text-christmas-green-light{% elif composite >= 50 %}text-yellow-400{% else %}text-christmas-brown{% endif %}">{{ composite|round(1) }}%</div>
                </div>
            </div>
        </div>

        <div class="px-6 py-4 space-y-4">
            <!-- Checklist Results Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Photos</div>
                    <div class="{% if debrief.photos_reviewed == 'pass' %}text-christmas-green-light{% elif debrief.photos_reviewed == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.photos_reviewed|upper if debrief.photos_reviewed else 'N/A' }}
                    </div>
                    {% if debrief.photos_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.photos_notes }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Invoice Summary</div>
                    <div class="{% if debrief.invoice_summary_score and debrief.invoice_summary_score >= 7 %}text-christmas-green-light{% elif debrief.invoice_summary_score and debrief.invoice_summary_score < 7 %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold text-lg">
                        {% if debrief.invoice_summary_score %}{{ debrief.invoice_summary_score }}/10{% else %}N/A{% endif %}
                    </div>
                    {% if debrief.invoice_summary_score and debrief.invoice_summary_score < 7 %}<div class="text-xs text-christmas-brown mt-1">Below standard</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Payment</div>
                    <div class="{% if debrief.payment_verified == 'pass' %}text-christmas-green-light{% elif debrief.payment_verified == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.payment_verified|upper if debrief.payment_verified else 'N/A' }}
                    </div>
                    {% if ticket.payment_method == 'Check' %}
                    <div class="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Check (not deposited)</div>
                    {% elif ticket.payment_method == 'Mobile Check Capture' %}
                    <div class="text-xs text-green-400 mt-1">‚úì Check (mobile deposit)</div>
                    {% elif 'Financing' in (ticket.payment_method or '') or ticket.payment_method == 'Wisetack' %}
                    <div class="text-xs text-blue-400 mt-1">üí≥ {{ ticket.payment_method }}</div>
                    {% elif ticket.payment_method == 'Finance Buydown' %}
                    <div class="text-xs text-blue-400 mt-1">üí≥ Finance Buydown</div>
                    {% elif ticket.payment_method %}
                    <div class="text-xs text-gray-400 mt-1">Method: {{ ticket.payment_method }}</div>
                    {% elif ticket.payment_collected %}
                    <div class="text-xs text-gray-400 mt-1">Paid (method unknown)</div>
                    {% elif ticket.invoice_balance > 0 %}
                    <div class="text-xs text-christmas-brown mt-1">Balance: ${{ "{:,.2f}".format(ticket.invoice_balance) }}</div>
                    {% endif %}
                    {% if debrief.no_payment_reason %}<div class="text-xs text-gray-400 mt-1">Note: {{ debrief.no_payment_reason }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Estimates</div>
                    <div class="{% if debrief.estimates_verified == 'pass' %}text-christmas-green-light{% elif debrief.estimates_verified == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.estimates_verified|upper if debrief.estimates_verified else 'N/A' }}
                    </div>
                    {% if debrief.estimates_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.estimates_notes }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Membership</div>
                    <div class="{% if debrief.membership_verified == 'pass' %}text-christmas-green-light{% elif debrief.membership_verified == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.membership_verified|upper if debrief.membership_verified else 'N/A' }}
                    </div>
                    {% if debrief.membership_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.membership_notes }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Google Reviews</div>
                    <div class="{% if debrief.google_reviews_discussed == 'pass' %}text-christmas-green-light{% elif debrief.google_reviews_discussed == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.google_reviews_discussed|upper if debrief.google_reviews_discussed else 'N/A' }}
                    </div>
                    {% if debrief.google_reviews_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.google_reviews_notes }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Replacement</div>
                    <div class="{% if debrief.replacement_discussed == 'pass' %}text-christmas-green-light{% elif debrief.replacement_discussed == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.replacement_discussed|upper if debrief.replacement_discussed else 'N/A' }}
                    </div>
                    {% if debrief.no_replacement_reason %}<div class="text-xs text-gray-400 mt-1">{{ debrief.no_replacement_reason }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Equipment Added</div>
                    <div class="{% if debrief.equipment_added == 'pass' %}text-christmas-green-light{% elif debrief.equipment_added == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.equipment_added|upper if debrief.equipment_added else 'N/A' }}
                    </div>
                    {% if debrief.equipment_added_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.equipment_added_notes }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-christmas-gold/30">
                    <div class="text-xs text-christmas-gold mb-1">Materials on Invoice üí∞</div>
                    <div class="{% if debrief.materials_on_invoice == 'pass' %}text-christmas-green-light{% elif debrief.materials_on_invoice == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.materials_on_invoice|upper if debrief.materials_on_invoice else 'N/A' }}
                    </div>
                    {% if debrief.materials_on_invoice_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.materials_on_invoice_notes }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Happy Call</div>
                    <div class="{% if debrief.happy_call == 'pass' %}text-christmas-green-light{% elif debrief.happy_call == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.happy_call|upper if debrief.happy_call else 'N/A' }}
                    </div>
                    {% if debrief.happy_call_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.happy_call_notes }}</div>{% endif %}
                </div>
            </div>

            <!-- Invoice Summary Notes -->
            {% if debrief.invoice_summary_notes %}
            <div class="bg-dark-bg rounded-lg p-4 border border-dark-border">
                <div class="text-xs text-gray-500 mb-2">Invoice Summary Notes</div>
                <div class="text-sm text-christmas-cream">{{ debrief.invoice_summary_notes }}</div>
            </div>
            {% endif %}

            <!-- G3 Contact -->
            {% if debrief.g3_contact_needed %}
            <div class="bg-christmas-gold/10 rounded-lg p-4 border border-christmas-gold/30">
                <div class="text-xs text-christmas-gold mb-2">‚ö†Ô∏è G3 Contact Needed</div>
                <div class="text-sm text-christmas-cream">{{ debrief.g3_notes or 'No details provided' }}</div>
            </div>
            {% endif %}

            <!-- General Notes -->
            {% if debrief.general_notes %}
            <div class="bg-dark-bg rounded-lg p-4 border border-dark-border">
                <div class="text-xs text-gray-500 mb-2">General Notes / Coaching Reminders</div>
                <div class="text-sm text-christmas-cream whitespace-pre-wrap">{{ debrief.general_notes }}</div>
            </div>
            {% endif %}

            <!-- Follow-up Section -->
            {% if debrief.followup_required %}
            <div class="bg-christmas-gold/10 rounded-lg p-4 border border-christmas-gold/30">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-christmas-gold font-semibold">‚ö†Ô∏è Follow-up Required</span>
                    {% if debrief.followup_completed %}
                    <span class="px-2 py-0.5 text-xs bg-christmas-green/20 text-christmas-green-light rounded">Completed</span>
                    {% else %}
                    <span class="px-2 py-0.5 text-xs bg-christmas-gold/20 text-christmas-gold rounded">Pending</span>
                    {% endif %}
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <div class="text-xs text-gray-500">Type</div>
                        <div class="text-christmas-cream">{{ debrief.followup_type|replace('_', ' ')|title if debrief.followup_type else 'Not specified' }}</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500">Assigned To</div>
                        <div class="text-christmas-cream">{{ debrief.followup_assigned_to or 'Unassigned' }}</div>
                    </div>
                </div>
                {% if debrief.followup_description %}
                <div class="mt-3">
                    <div class="text-xs text-gray-500 mb-1">Description</div>
                    <div class="text-sm text-christmas-cream">{{ debrief.followup_description }}</div>
                </div>
                {% endif %}
                {% if debrief.st_task_id %}
                <div class="mt-3 text-xs text-gray-500">
                    ServiceTitan Task #{{ debrief.st_task_id }} created
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Debrief Form (for new debriefs or re-debriefing) -->
    <form action="/api/job/{{ ticket.job_id }}/debrief/form" method="POST" class="bg-dark-card rounded-lg border border-dark-border {% if debrief %}opacity-60 hover:opacity-100 transition{% endif %}">
        <div class="px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-christmas-cream">{% if debrief %}Re-Debrief / Update{% else %}Debrief Checklist{% endif %}</h2>
            <p class="text-sm text-gray-500 mt-1">{% if debrief %}Submit again to update this debrief.{% else %}Complete all items before submitting.{% endif %}</p>
        </div>

        <div class="px-6 py-4 space-y-6">
            <!-- 1. Photos -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Photos Reviewed ({{ ticket.photo_count }} photos attached)
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-72 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Photos</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Before/after photos uploaded showing the work performed and equipment<br>
                            <span class="text-christmas-brown">Fail:</span> No photos, blurry photos, or missing key shots (before/after)<br>
                            <span class="text-gray-500">N/A:</span> Phone consultation, remote diagnostic, or admin-only visit
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="photos_reviewed" value="pass" class="sr-only" required>
                        <span>‚úì Pass</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="photos_reviewed" value="fail" class="sr-only">
                        <span>‚úó Fail</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="photos_reviewed" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="photos_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 2. Invoice Summary Score -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Invoice Summary Quality (1-10)
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-80 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Score Invoice Summary</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">8-10:</span> Clear diagnosis, detailed work description, recommendations for future, professional tone<br>
                            <span class="text-christmas-gold">5-7:</span> Basic info present but missing details or recommendations<br>
                            <span class="text-christmas-brown">1-4:</span> Vague, incomplete, or just "completed service"
                        </div>
                    </div>
                </label>
                <div class="flex items-center space-x-4">
                    <input type="range" name="invoice_summary_score" id="invoice-score-slider" min="1" max="10"
                        class="w-48 h-2 rounded-lg appearance-none cursor-pointer opacity-50"
                        oninput="setInvoiceScore(this.value)">
                    <span id="score-display" class="text-2xl font-bold text-gray-500 w-8">-</span>
                    <span class="text-sm text-gray-500">/ 10</span>
                    <span id="score-required" class="text-xs text-christmas-brown ml-2">‚Üê Select a score</span>
                </div>
                <input type="hidden" name="invoice_summary_score_set" id="invoice-score-set" value="false">
                <input type="text" name="invoice_summary_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- Membership Visit Context Banner (for tune-up jobs) -->
            {% if ticket.membership_sold and ticket.membership_visit_type and ticket.membership_visit_type != 'unknown' %}
            <div class="rounded-lg border mb-2 {% if ticket.membership_visit_covered %}bg-green-900/20 border-green-600/50{% else %}bg-yellow-900/20 border-yellow-600/50{% endif %}">
                <div class="px-4 py-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-sm font-semibold {% if ticket.membership_visit_covered %}text-green-200{% else %}text-yellow-200{% endif %} flex items-center gap-2">
                                {% if ticket.membership_visit_covered %}
                                <span>‚úì</span> Membership Visit - FREE
                                {% else %}
                                <span>‚ö†Ô∏è</span> Membership Visit - PAYMENT NEEDED
                                {% endif %}
                            </h3>
                            <p class="text-xs text-gray-400 mt-1">
                                {{ ticket.membership_type or "Active Membership" }}
                                {% if ticket.membership_expires %}
                                ¬∑ Expires {{ ticket.membership_expires.strftime('%b %d, %Y') }}
                                {% endif %}
                                {% if ticket.membership_id %}
                                ¬∑ <a href="https://go.servicetitan.com/#/Membership/Index/{{ ticket.membership_id }}"
                                     target="_blank"
                                     class="text-christmas-green-light hover:text-christmas-green hover:underline">
                                    View in ST ‚Üó
                                </a>
                                {% endif %}
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold {% if ticket.membership_visit_covered %}text-green-200{% else %}text-yellow-200{% endif %}">
                                Visit {{ ticket.membership_visit_number }} of {{ ticket.membership_visits_included }}
                            </div>
                            <div class="text-xs text-gray-500">
                                {{ ticket.membership_visit_type|replace('_', ' ')|title }}
                            </div>
                        </div>
                    </div>

                    <!-- Visit breakdown -->
                    <div class="mt-3 grid grid-cols-3 gap-2 text-center">
                        <div class="bg-dark-bg/50 rounded-lg p-2 border border-dark-border">
                            <div class="text-lg font-bold text-gray-200">{{ ticket.membership_visits_used }}</div>
                            <div class="text-xs text-gray-500">Used</div>
                        </div>
                        <div class="bg-dark-bg/50 rounded-lg p-2 border border-dark-border">
                            <div class="text-lg font-bold text-gray-200">{{ ticket.membership_visits_included - ticket.membership_visits_used }}</div>
                            <div class="text-xs text-gray-500">Remaining</div>
                        </div>
                        <div class="bg-dark-bg/50 rounded-lg p-2 border border-dark-border">
                            <div class="text-lg font-bold {% if ticket.membership_visit_covered %}text-green-200{% else %}text-yellow-200{% endif %}">
                                {% if ticket.membership_visit_covered %}$0{% else %}$${% endif %}
                            </div>
                            <div class="text-xs text-gray-500">This Visit</div>
                        </div>
                    </div>

                    <!-- Payment info -->
                    {% if ticket.membership_price or ticket.membership_last_payment_date %}
                    <div class="mt-2 grid grid-cols-2 gap-2 text-center">
                        {% if ticket.membership_price %}
                        <div class="bg-dark-bg/50 rounded-lg p-2 border border-dark-border">
                            <div class="text-sm font-bold text-gray-200">
                                ${{ "%.2f"|format(ticket.membership_price) }}
                                {% if ticket.membership_billing_frequency %}
                                <span class="text-xs text-gray-500">/{{ ticket.membership_billing_frequency|lower }}</span>
                                {% endif %}
                            </div>
                            <div class="text-xs text-gray-500">Membership Price</div>
                        </div>
                        {% endif %}
                        {% if ticket.membership_last_payment_date %}
                        <div class="bg-dark-bg/50 rounded-lg p-2 border border-dark-border">
                            <div class="text-sm font-bold text-gray-200">
                                {{ ticket.membership_last_payment_date.strftime('%b %d, %Y') if ticket.membership_last_payment_date else 'N/A' }}
                                {% if ticket.membership_last_payment_amount %}
                                <span class="text-xs text-gray-500">(${{ "%.2f"|format(ticket.membership_last_payment_amount) }})</span>
                                {% endif %}
                            </div>
                            <div class="text-xs text-gray-500">Last Payment</div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Data warning if applicable -->
                    {% if ticket.membership_data_warning %}
                    <div class="mt-2 p-2 bg-yellow-900/30 border border-yellow-600/50 rounded text-xs text-yellow-200">
                        ‚ö†Ô∏è <strong>Data Note:</strong> {{ ticket.membership_data_warning }}
                    </div>
                    {% endif %}

                    <!-- Payment guidance -->
                    {% if not ticket.membership_visit_covered %}
                    <div class="mt-2 p-2 bg-yellow-900/30 border border-yellow-600/50 rounded text-xs text-yellow-200">
                        Customer has used all {{ ticket.membership_visits_included }} included {{ ticket.membership_visit_type|replace('_', ' ') }} visits.
                        <strong>This visit requires payment OR membership renewal.</strong>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% elif ticket.job_category == 'Maintenance' and not ticket.membership_sold %}
            <div class="rounded-lg border border-gray-700 bg-gray-800/30 mb-2">
                <div class="px-4 py-2 flex items-center gap-2">
                    <span class="text-gray-500">üí°</span>
                    <div>
                        <div class="text-xs text-gray-400">No Active Membership</div>
                        <div class="text-xs text-gray-500">Maintenance visit - good opportunity to offer membership!</div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- 3. Payment -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Payment Verified
                    <span class="{% if ticket.payment_collected %}text-christmas-green-light{% else %}text-christmas-brown{% endif %}">
                        ({% if ticket.payment_collected %}Collected{% if ticket.payment_method %} via {{ ticket.payment_method }}{% endif %}{% else %}Not Collected - ${{ "{:,.2f}".format(ticket.invoice_balance) }} balance{% endif %})
                    </span>
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-80 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Payment</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Paid in full OR financing approved with proper notes in ServiceTitan<br>
                            <span class="text-christmas-brown">Fail:</span> Unpaid balance with no documented reason or payment plan<br>
                            <span class="text-gray-500">N/A:</span> Warranty work, no-charge diagnostic, or pre-approved commercial billing
                        </div>
                    </div>
                </label>
                {% if ticket.payment_method == 'Check' %}
                <div class="bg-yellow-900/30 border border-yellow-600/50 rounded-lg p-2 text-xs text-yellow-200">
                    ‚ö†Ô∏è <strong>Check collected but NOT deposited</strong> - Needs to be dropped off at the shop for deposit
                </div>
                {% elif ticket.payment_method == 'Mobile Check Capture' %}
                <div class="bg-green-900/30 border border-green-600/50 rounded-lg p-2 text-xs text-green-200">
                    ‚úì Check deposited via mobile
                </div>
                {% elif 'Financing' in (ticket.payment_method or '') or ticket.payment_method == 'Wisetack' %}
                <div class="bg-blue-900/30 border border-blue-600/50 rounded-lg p-2 text-xs text-blue-200">
                    üí≥ <strong>Financing Approved</strong> - {{ ticket.payment_method }}
                    <div class="text-blue-300/70 mt-1">Verify financing paperwork is complete in ServiceTitan. Customer should have received approval confirmation.</div>
                </div>
                {% elif ticket.payment_method == 'Finance Buydown' %}
                <div class="bg-blue-900/30 border border-blue-600/50 rounded-lg p-2 text-xs text-blue-200">
                    üí≥ <strong>Finance Buydown Applied</strong>
                    <div class="text-blue-300/70 mt-1">Rate buydown was used to give customer a lower financing rate. Verify buydown was properly documented.</div>
                </div>
                {% endif %}
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="payment_verified" value="pass" class="sr-only" required {% if ticket.payment_collected and ticket.payment_method %}checked{% endif %}>
                        <span>‚úì Pass</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="payment_verified" value="fail" class="sr-only">
                        <span>‚úó Fail</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="payment_verified" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="no_payment_reason" placeholder="If not collected, why?"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 4. Estimates -->
            <div class="space-y-2 {% if ticket.is_opportunity %}ring-2 ring-christmas-gold/50 rounded-lg p-3 -mx-3{% endif %}">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Estimates Offered/Discussed ({{ ticket.estimate_count }} created{% if ticket.estimates_total %}, ${{ "{:,.2f}".format(ticket.estimates_total) }} total{% endif %})
                    {% if ticket.is_opportunity %}
                    <span class="ml-2 text-christmas-gold text-xs font-semibold">üéØ OPPORTUNITY JOB - Estimates Expected</span>
                    {% endif %}
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-80 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Estimates</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Estimate created for additional repairs, replacements, or upgrades<br>
                            <span class="text-christmas-brown">Fail:</span> Opportunity job (üéØ) with no estimates presented to customer<br>
                            <span class="text-gray-500">N/A:</span> Simple maintenance, tune-up, or no reasonable upsell opportunity
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="estimates_verified" value="pass" class="sr-only" required>
                        <span>‚úì Pass</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="estimates_verified" value="fail" class="sr-only">
                        <span>‚úó Fail</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="estimates_verified" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="estimates_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 5. Membership -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Membership Offered
                    <span class="{% if ticket.membership_sold %}text-christmas-green-light{% else %}text-gray-500{% endif %}">
                        ({{ "Sold: " + (ticket.membership_type or "Unknown") if ticket.membership_sold else "Not Sold" }})
                    </span>
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-72 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Membership</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Maintenance plan was offered and explained to customer<br>
                            <span class="text-christmas-brown">Fail:</span> Not offered when customer was eligible<br>
                            <span class="text-gray-500">N/A:</span> Customer already has active membership or commercial account
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="membership_verified" value="pass" class="sr-only" required>
                        <span>‚úì Pass</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="membership_verified" value="fail" class="sr-only">
                        <span>‚úó Fail</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="membership_verified" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="membership_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 6. Google Reviews -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Google Reviews Discussed
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-72 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Google Reviews</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Tech asked customer to leave a Google review<br>
                            <span class="text-christmas-brown">Fail:</span> Not mentioned to a satisfied customer<br>
                            <span class="text-gray-500">N/A:</span> Customer was unhappy, complaint situation, or not appropriate to ask
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="google_reviews_discussed" value="pass" class="sr-only" required>
                        <span>‚úì Pass</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="google_reviews_discussed" value="fail" class="sr-only">
                        <span>‚úó Fail</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="google_reviews_discussed" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="google_reviews_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 7. Replacement Discussion -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Replacement Discussed (if aged equipment)
                    {% if ticket.equipment_age_years %}
                    <span class="{% if ticket.equipment_age_years >= 12 %}text-christmas-gold{% else %}text-gray-500{% endif %}">
                        (Equipment age: {{ ticket.equipment_age_years }} years)
                    </span>
                    {% endif %}
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-72 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Replacement Discussion</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Replacement options discussed for equipment 12+ years old<br>
                            <span class="text-christmas-brown">Fail:</span> Old equipment but no replacement conversation<br>
                            <span class="text-gray-500">N/A:</span> Newer equipment, or replacement not relevant to visit type
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="replacement_discussed" value="pass" class="sr-only" required>
                        <span>‚úì Pass</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="replacement_discussed" value="fail" class="sr-only">
                        <span>‚úó Fail</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="replacement_discussed" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="no_replacement_reason" placeholder="If not discussed, why?"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- Equipment at Location Context Banner -->
            {% if ticket.installed_equipment_count is not none %}
            <div class="rounded-lg border border-gray-700 bg-dark-bg mb-4">
                <div class="px-4 py-3 border-b border-dark-border flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-gray-400">üîß</span>
                        <h3 class="text-sm font-semibold text-christmas-cream">
                            Equipment on Location Record
                            <span class="text-gray-500 font-normal">({{ ticket.installed_equipment_count or 0 }})</span>
                        </h3>
                    </div>
                    {% if ticket.location_id %}
                    <a href="https://go.servicetitan.com/#/Location/Index/{{ ticket.location_id }}"
                       target="_blank"
                       class="text-xs text-christmas-green-light hover:text-christmas-green hover:underline">
                        View Location in ST ‚Üó
                    </a>
                    {% endif %}
                </div>
                <div class="px-4 py-3">
                    {% if ticket.installed_equipment and ticket.installed_equipment|length > 0 %}
                    <div class="space-y-2">
                        {% for eq in ticket.installed_equipment %}
                        {% set install_date = eq.installedOn[:10] if eq.installedOn else None %}
                        {% set job_date = ticket.completed_at.strftime('%Y-%m-%d') if ticket.completed_at else None %}
                        {% set added_today = install_date == job_date if install_date and job_date else False %}
                        <div class="flex items-center justify-between bg-dark-card rounded p-2 border {% if added_today %}border-christmas-green/50 bg-christmas-green/10{% else %}border-dark-border{% endif %}">
                            <div class="flex items-center gap-3">
                                <span class="text-gray-500">üì¶</span>
                                <div>
                                    <span class="text-christmas-cream text-sm font-medium">{{ eq.name or 'Unknown Equipment' }}</span>
                                    {% if eq.manufacturer or eq.model %}
                                    <span class="text-gray-500 text-xs ml-1">({{ eq.manufacturer }}{% if eq.manufacturer and eq.model %} {% endif %}{{ eq.model }})</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex items-center gap-3 text-xs">
                                {% if eq.serialNumber %}
                                <span class="text-gray-400">S/N: {{ eq.serialNumber }}</span>
                                {% endif %}
                                {% if added_today %}
                                <span class="px-2 py-0.5 bg-christmas-green/20 text-christmas-green-light rounded font-semibold">Added Today ‚úì</span>
                                {% elif install_date %}
                                <span class="text-gray-500">{{ install_date }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3 p-2 bg-blue-900/20 border border-blue-600/30 rounded text-xs text-blue-200">
                        üí° Check if equipment serviced/installed today was added to the location record.
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <span class="text-gray-500">üì≠</span>
                        <p class="text-gray-400 text-sm mt-1">No equipment on location record</p>
                        <p class="text-xs text-christmas-gold mt-2">‚ö†Ô∏è Equipment should be added after service/install visits</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- 8. Equipment Added to Location -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Equipment Added to ST Location?
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-72 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Equipment Added</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Equipment serviced/installed was added to customer's ST location record<br>
                            <span class="text-christmas-brown">Fail:</span> Equipment not added or updated in ServiceTitan<br>
                            <span class="text-gray-500">N/A:</span> No equipment involved (drain cleaning, etc.) or equipment already on file
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="equipment_added" value="pass" class="sr-only" required>
                        <span>‚úì Yes</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="equipment_added" value="fail" class="sr-only">
                        <span>‚úó No</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="equipment_added" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="equipment_added_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- Invoice Line Items Context Banner -->
            {% if ticket.invoice_items is not none %}
            <div class="rounded-lg border border-christmas-gold/30 bg-christmas-gold/5 mb-4">
                <div class="px-4 py-3 border-b border-christmas-gold/20 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-christmas-gold">üí∞</span>
                        <h3 class="text-sm font-semibold text-christmas-cream">
                            Items on Invoice
                            <span class="text-gray-500 font-normal">({{ (ticket.invoice_items|length) if ticket.invoice_items else 0 }})</span>
                        </h3>
                    </div>
                    {% if ticket.invoice_id %}
                    <a href="https://go.servicetitan.com/#/Invoice/Index/{{ ticket.invoice_id }}"
                       target="_blank"
                       class="text-xs text-christmas-green-light hover:text-christmas-green hover:underline">
                        View Invoice in ST ‚Üó
                    </a>
                    {% endif %}
                </div>

                <!-- Summary counts -->
                <div class="px-4 py-2 grid grid-cols-3 gap-2 text-center border-b border-christmas-gold/10">
                    <div class="bg-dark-bg rounded-lg p-2 border border-dark-border">
                        <div class="text-lg font-bold text-gray-200">{{ ticket.invoice_materials_count or 0 }}</div>
                        <div class="text-xs text-gray-500">Materials</div>
                    </div>
                    <div class="bg-dark-bg rounded-lg p-2 border border-dark-border">
                        <div class="text-lg font-bold text-gray-200">{{ ticket.invoice_equipment_count or 0 }}</div>
                        <div class="text-xs text-gray-500">Equipment</div>
                    </div>
                    <div class="bg-dark-bg rounded-lg p-2 border border-dark-border">
                        <div class="text-lg font-bold text-gray-200">{{ ticket.invoice_services_count or 0 }}</div>
                        <div class="text-xs text-gray-500">Services</div>
                    </div>
                </div>

                <div class="px-4 py-3">
                    {% if ticket.invoice_items and ticket.invoice_items|length > 0 %}
                    <details class="group">
                        <summary class="cursor-pointer text-sm text-christmas-cream hover:text-christmas-gold transition flex items-center gap-2">
                            <span class="text-gray-500 group-open:rotate-90 transition-transform">‚ñ∂</span>
                            Show all items
                        </summary>
                        <div class="mt-2 space-y-1 pl-4">
                            {% for item in ticket.invoice_items %}
                            <div class="flex items-center justify-between text-xs py-1 border-b border-dark-border/50 last:border-0">
                                <div class="flex items-center gap-2">
                                    {% if item.type and 'material' in item.type|lower %}
                                    <span class="text-gray-500" title="Material">üì¶</span>
                                    {% elif item.type and 'equipment' in item.type|lower %}
                                    <span class="text-gray-500" title="Equipment">üîß</span>
                                    {% elif item.type and ('service' in item.type|lower or 'labor' in item.type|lower) %}
                                    <span class="text-gray-500" title="Service">üîπ</span>
                                    {% else %}
                                    <span class="text-gray-500">‚Ä¢</span>
                                    {% endif %}
                                    <span class="text-christmas-cream">{{ item.skuName or 'Unknown Item' }}</span>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="text-gray-500">x{{ item.quantity or 1 }}</span>
                                    <span class="text-gray-400 w-20 text-right">${{ "%.2f"|format(item.totalPrice or 0) }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </details>
                    <div class="mt-3 p-2 bg-blue-900/20 border border-blue-600/30 rounded text-xs text-blue-200">
                        üí° Ask tech: "Did you add all materials you used to the invoice?"
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <span class="text-gray-500">üìã</span>
                        <p class="text-gray-400 text-sm mt-1">No line items on invoice</p>
                        <p class="text-xs text-christmas-gold mt-2">‚ö†Ô∏è Materials used should be added for gross margin tracking</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- 9. Materials/Equipment on Invoice (for Gross Margin) -->
            <div class="space-y-2 bg-christmas-gold/5 border border-christmas-gold/20 rounded-lg p-4 -mx-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Materials & Equipment on Invoice?
                    <span class="text-christmas-gold text-xs ml-1">üí∞ Critical for Gross Margin</span>
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-80 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Materials on Invoice</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> All parts, materials, and equipment used are itemized on invoice<br>
                            <span class="text-christmas-brown">Fail:</span> Missing items - tech used materials not charged to customer<br>
                            <span class="text-gray-500">N/A:</span> Diagnostic only, no materials used
                        </div>
                    </div>
                </label>
                <p class="text-xs text-gray-400 mb-2">Ask tech: "Did you add all materials and equipment used to the invoice?"</p>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="materials_on_invoice" value="pass" class="sr-only" required>
                        <span>‚úì Yes - All Added</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="materials_on_invoice" value="fail" class="sr-only">
                        <span>‚úó No - Missing Items</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="materials_on_invoice" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="materials_on_invoice_notes" placeholder="Tech response / missing items..."
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 10. Happy Call -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Happy Call Completed
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-72 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Happy Call</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Happy call completed, customer confirmed satisfaction<br>
                            <span class="text-christmas-brown">Fail:</span> Happy call attempted but customer had concerns or complaints<br>
                            <span class="text-gray-500">N/A:</span> Unable to reach customer, voicemail left, or not applicable
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="happy_call" value="pass" class="sr-only" required>
                        <span>‚úì Yes</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="happy_call" value="fail" class="sr-only">
                        <span>‚úó No</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="happy_call" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="happy_call_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 11. G3 Contact -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream">G3 Contact Needed?</label>
                <div class="flex items-center space-x-4">
                    <label class="flex items-center text-gray-300">
                        <input type="radio" name="g3_contact_needed" value="false" checked class="mr-2">
                        <span>No</span>
                    </label>
                    <label class="flex items-center text-gray-300">
                        <input type="radio" name="g3_contact_needed" value="true" class="mr-2">
                        <span>Yes</span>
                    </label>
                </div>
                <input type="text" name="g3_notes" placeholder="G3 notes (if needed)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <hr class="border-dark-border">

            <!-- Follow-up Section -->
            <div class="bg-christmas-gold/10 border border-christmas-gold/30 rounded-lg p-4 space-y-4">
                <div class="flex items-center justify-between">
                    <label class="text-sm font-semibold text-christmas-gold">Follow-up Required?</label>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center text-gray-300">
                            <input type="radio" name="followup_required" value="false" checked
                                class="mr-2" onchange="toggleFollowup(false)">
                            <span>No</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="followup_required" value="true"
                                class="mr-2" onchange="toggleFollowup(true)">
                            <span class="text-christmas-gold font-medium">Yes - Flag for follow-up</span>
                        </label>
                    </div>
                </div>

                <div id="followup-details" class="hidden space-y-4 pt-4 border-t border-christmas-gold/30">
                    <div>
                        <label class="block text-sm font-medium text-christmas-cream mb-2">Follow-up Type</label>
                        <select name="followup_type" class="w-full md:w-1/2 rounded-md p-2 border">
                            <option value="">Select type...</option>
                            <option value="tech_coaching">üéì Tech Coaching Needed</option>
                            <option value="manager_review">üëî Manager Review Required</option>
                            <option value="customer_callback">üìû Customer Callback Needed</option>
                            <option value="billing">üí∞ Billing Issue</option>
                            <option value="quality">‚ö†Ô∏è Quality Issue</option>
                            <option value="other">üìå Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-christmas-cream mb-2">Assign To</label>
                        <input type="text" name="followup_assigned_to"
                            placeholder="Tech name, manager, or leave blank"
                            class="w-full md:w-1/2 rounded-md p-2 border text-sm">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-christmas-cream mb-2">Follow-up Description</label>
                        <textarea name="followup_description" rows="2"
                            placeholder="What needs to be addressed? Be specific..."
                            class="w-full rounded-md p-2 border"></textarea>
                    </div>

                    <div class="flex items-center space-x-2 text-sm text-christmas-gold">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm0 14a6 6 0 110-12 6 6 0 010 12zm-1-5h2v2H9v-2zm0-6h2v4H9V5z"/>
                        </svg>
                        <span>This will send a notification to Slack #debrief-followups</span>
                    </div>
                </div>
            </div>

            <hr class="border-dark-border">

            <!-- General Notes -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream">General Notes / Coaching Reminders</label>
                <textarea name="general_notes" rows="3" placeholder="Any additional notes for this debrief..."
                    class="w-full rounded-md p-2 border"></textarea>
            </div>
        </div>

        <!-- Submit -->
        <div class="px-6 py-4 bg-dark-bg rounded-b-lg flex justify-between items-center border-t border-dark-border">
            <a href="/queue" class="text-gray-500 hover:text-christmas-cream transition">Cancel</a>
            <button type="submit"
                class="bg-christmas-green hover:bg-christmas-green-dark text-christmas-cream font-semibold py-3 px-8 rounded-lg shadow transition">
                Complete Debrief ‚úì
            </button>
        </div>
    </form>
</div>

<script>
// Track if form has unsaved changes
let formDirty = false;
let formSubmitting = false;

// Mark form as dirty when any input changes
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
        // Listen for all input changes
        form.addEventListener('change', function() {
            formDirty = true;
        });
        form.addEventListener('input', function() {
            formDirty = true;
        });

        // Clear dirty flag on submit
        form.addEventListener('submit', function(e) {
            // Check if invoice score was set
            const scoreSet = document.getElementById('invoice-score-set');
            if (scoreSet && scoreSet.value === 'false') {
                e.preventDefault();
                alert('Please select an Invoice Summary Quality score before submitting.');
                document.getElementById('invoice-score-slider').focus();
                return false;
            }
            formSubmitting = true;
            formDirty = false;
        });
    }
});

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (formDirty && !formSubmitting) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
    }
});

// Handle "Back to Queue" link click
document.querySelectorAll('a[href="/queue"]').forEach(function(link) {
    link.addEventListener('click', function(e) {
        if (formDirty && !formSubmitting) {
            if (!confirm('You have unsaved changes. Are you sure you want to leave?')) {
                e.preventDefault();
            }
        }
    });
});

// Invoice score function - requires explicit selection
function setInvoiceScore(value) {
    const display = document.getElementById('score-display');
    const slider = document.getElementById('invoice-score-slider');
    const required = document.getElementById('score-required');
    const scoreSet = document.getElementById('invoice-score-set');

    display.textContent = value;
    display.classList.remove('text-gray-500');
    display.classList.add('text-christmas-green-light');
    slider.classList.remove('opacity-50');
    required.classList.add('hidden');
    scoreSet.value = 'true';
    formDirty = true;
}

function toggleFollowup(show) {
    const details = document.getElementById('followup-details');
    if (show) {
        details.classList.remove('hidden');
    } else {
        details.classList.add('hidden');
    }
}

async function addToSpotCheck(debriefSessionId) {
    if (!confirm('Add this job to the spot check queue?')) return;

    try {
        const response = await fetch(`/api/spot-checks/manual/${debriefSessionId}`, { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            alert('Added to spot check queue!');
            // Redirect to the spot check form
            window.location.href = `/spot-check/${result.spot_check_id}`;
        } else {
            alert(result.message || 'Failed to add spot check');
        }
    } catch (error) {
        console.error('Failed to add spot check:', error);
        alert('Failed to add spot check');
    }
}
</script>
{% endblock %}
