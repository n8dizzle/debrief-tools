{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Back Button -->
    <a href="/queue" class="inline-flex items-center text-christmas-green-light hover:text-christmas-green mb-4">
        ‚Üê Back to Queue
    </a>

    <!-- Job Header -->
    <div class="bg-dark-card rounded-lg border border-dark-border mb-6">
        <div class="px-6 py-4 border-b border-dark-border">
            <div class="flex justify-between items-start">
                <div>
                    <div class="flex items-center gap-3">
                        <h1 class="text-2xl font-bold text-christmas-cream">Job #{{ ticket.job_number }}</h1>
                        <a href="https://go.servicetitan.com/#/Job/Index/{{ ticket.job_id }}"
                           target="_blank"
                           class="text-sm text-christmas-green-light hover:text-christmas-green hover:underline">
                            View in ServiceTitan ‚Üó
                        </a>
                        {% if debrief %}
                        <!-- Spot Check Button (for completed debriefs) -->
                        {% if spot_check %}
                        <a href="/spot-check/{{ spot_check.id }}"
                           class="px-3 py-1 text-sm bg-christmas-gold/20 text-christmas-gold rounded-lg border border-christmas-gold/50 hover:bg-christmas-gold/30 transition">
                            View Spot Check
                        </a>
                        {% else %}
                        <button onclick="addToSpotCheck({{ debrief.id }})"
                                class="px-3 py-1 text-sm bg-christmas-gold/20 text-christmas-gold rounded-lg border border-christmas-gold/50 hover:bg-christmas-gold/30 transition">
                            + Spot Check
                        </button>
                        {% endif %}
                        {% endif %}
                    </div>
                    <div class="mt-1 flex items-center space-x-3 flex-wrap gap-2">
                        <span class="px-2 py-1 text-sm rounded-full bg-christmas-green/20 text-christmas-green-light">{{ ticket.job_type_name or 'Unknown' }}</span>
                        <span class="px-2 py-1 text-sm rounded-full bg-dark-border text-gray-400">{{ ticket.trade_type or 'Unknown' }}</span>
                        {% if ticket.job_status and ticket.job_status != 'Completed' %}
                        <span class="px-2 py-1 text-sm rounded-full {% if ticket.job_status == 'Canceled' %}bg-christmas-brown/20 text-christmas-brown{% else %}bg-christmas-gold/20 text-christmas-gold{% endif %}">
                            {{ ticket.job_status }}
                        </span>
                        {% endif %}
                        {% if ticket.is_new_customer %}
                        <span class="px-2 py-1 text-sm rounded-full bg-christmas-green/20 text-christmas-green-light">New Customer</span>
                        {% endif %}
                        {% if ticket.is_opportunity %}
                        <span class="px-2 py-1 text-sm rounded-full bg-christmas-gold/20 text-christmas-gold font-semibold" title="This job has a conversion opportunity tag - estimates should be presented">üéØ Opportunity</span>
                        {% endif %}
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-christmas-cream">${{ "{:,.2f}".format(ticket.invoice_total) }}</div>
                    <div class="text-sm {% if ticket.payment_collected %}text-christmas-green-light{% else %}text-christmas-brown font-semibold{% endif %}">
                        {% if ticket.payment_collected %}‚úì Payment Collected{% if ticket.payment_method %} ({{ ticket.payment_method }}){% endif %}{% else %}‚úó Payment Outstanding: ${{ "{:,.2f}".format(ticket.invoice_balance) }}{% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Details Grid -->
        <div class="px-6 py-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
                <div class="text-gray-500">Customer</div>
                <div class="font-medium text-christmas-cream">{{ ticket.customer_name or 'Unknown' }}</div>
            </div>
            <div>
                <div class="text-gray-500">Technician{% if ticket.all_techs and ticket.all_techs|length > 1 %}s{% endif %}</div>
                <div class="font-medium text-christmas-cream">
                    {% if ticket.all_techs and ticket.all_techs|length > 1 %}
                        {% for tech in ticket.all_techs %}{{ tech.name }}{% if not loop.last %}, {% endif %}{% endfor %}
                    {% else %}
                        {{ ticket.tech_name or 'Unassigned' }}
                    {% endif %}
                </div>
            </div>
            <div>
                <div class="text-gray-500">Completed</div>
                <div class="font-medium text-christmas-cream">{{ (ticket.completed_at|central).strftime('%b %d, %I:%M %p') if ticket.completed_at else 'N/A' }}</div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="px-6 py-4 bg-dark-bg rounded-b-lg grid grid-cols-4 gap-4 text-center border-t border-dark-border">
            <div>
                <div class="text-2xl font-bold text-christmas-green-light">{{ ticket.photo_count }}</div>
                <div class="text-xs text-gray-500">Photos</div>
            </div>
            <div>
                <div class="text-2xl font-bold text-christmas-green-light">{{ ticket.form_count or 0 }}</div>
                <div class="text-xs text-gray-500">Forms</div>
            </div>
            <div>
                <div class="text-2xl font-bold text-christmas-gold">{{ ticket.estimate_count }}</div>
                <div class="text-xs text-gray-500">Estimates</div>
            </div>
            <div>
                <div class="text-2xl font-bold {% if ticket.membership_sold %}text-christmas-green-light{% else %}text-gray-500{% endif %}">
                    {% if ticket.membership_sold %}Yes{% else %}No{% endif %}
                </div>
                <div class="text-xs text-gray-500">Membership</div>
            </div>
        </div>
    </div>

    <!-- Invoice Summary Display -->
    {% if ticket.invoice_summary %}
    <div class="bg-dark-card rounded-lg border border-dark-border mb-6">
        <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
            <h2 class="text-lg font-semibold text-christmas-cream">Invoice Summary</h2>
            {% if ticket.invoice_author %}
            <span class="text-sm text-gray-500">Written by: <span class="text-christmas-cream">{{ ticket.invoice_author }}</span></span>
            {% endif %}
        </div>
        <div class="px-6 py-4">
            <div class="bg-dark-bg rounded p-4 text-gray-300 whitespace-pre-wrap border border-dark-border">{{ ticket.invoice_summary }}</div>
        </div>
    </div>
    {% endif %}

    <!-- Forms Completed -->
    {% if form_submissions %}
    <div class="bg-dark-card rounded-lg border border-dark-border mb-6">
        <div class="px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-christmas-cream">Forms Completed ({{ form_submissions|length }})</h2>
        </div>
        <div class="px-6 py-4">
            <div class="space-y-2">
                {% for form in form_submissions %}
                <div class="flex items-center justify-between bg-dark-bg rounded p-3 border border-dark-border">
                    <div class="flex items-center gap-3">
                        <span class="text-christmas-green-light">üìù</span>
                        <span class="text-christmas-cream font-medium">{{ form.formName }}</span>
                        <span class="text-xs text-gray-500">{{ form.submittedOn[:10] if form.submittedOn else '' }}</span>
                    </div>
                    <a href="https://go.servicetitan.com/#/new/forms20/AssignedTo/Job/{{ ticket.job_id }}/Form/{{ form.formId }}/Submission/{{ form.id }}/View"
                       target="_blank"
                       class="text-sm text-christmas-green-light hover:text-christmas-green hover:underline">
                        View in ST ‚Üó
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Completed Debrief Review (if already debriefed) -->
    {% if debrief %}
    <div class="bg-dark-card rounded-lg border border-christmas-green/50 mb-6">
        <div class="px-6 py-4 border-b border-dark-border bg-christmas-green/10">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-semibold text-christmas-cream">‚úì Debrief Completed</h2>
                    <p class="text-sm text-gray-400 mt-1">
                        By {{ debrief.dispatcher.name if debrief.dispatcher else 'Unknown' }} on
                        {{ (debrief.completed_at|central).strftime('%b %d, %Y at %I:%M %p') if debrief.completed_at else 'N/A' }}
                    </p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">Invoice Score</div>
                    <div class="text-2xl font-bold text-christmas-green-light">{{ debrief.invoice_summary_score or 5 }}/10</div>
                </div>
            </div>
        </div>

        <div class="px-6 py-4 space-y-4">
            <!-- Checklist Results Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Photos</div>
                    <div class="{% if debrief.photos_reviewed == 'pass' %}text-christmas-green-light{% elif debrief.photos_reviewed == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.photos_reviewed|upper if debrief.photos_reviewed else 'N/A' }}
                    </div>
                    {% if debrief.photos_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.photos_notes }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Payment</div>
                    <div class="{% if debrief.payment_verified == 'pass' %}text-christmas-green-light{% elif debrief.payment_verified == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.payment_verified|upper if debrief.payment_verified else 'N/A' }}
                    </div>
                    {% if ticket.payment_method == 'Check' %}
                    <div class="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Check (not deposited)</div>
                    {% elif ticket.payment_method == 'Mobile Check Capture' %}
                    <div class="text-xs text-green-400 mt-1">‚úì Check (mobile deposit)</div>
                    {% elif ticket.payment_method %}
                    <div class="text-xs text-gray-400 mt-1">Method: {{ ticket.payment_method }}</div>
                    {% elif ticket.payment_collected %}
                    <div class="text-xs text-gray-400 mt-1">Paid (method unknown)</div>
                    {% elif ticket.invoice_balance > 0 %}
                    <div class="text-xs text-christmas-brown mt-1">Balance: ${{ "{:,.2f}".format(ticket.invoice_balance) }}</div>
                    {% endif %}
                    {% if debrief.no_payment_reason %}<div class="text-xs text-gray-400 mt-1">Note: {{ debrief.no_payment_reason }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Estimates</div>
                    <div class="{% if debrief.estimates_verified == 'pass' %}text-christmas-green-light{% elif debrief.estimates_verified == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.estimates_verified|upper if debrief.estimates_verified else 'N/A' }}
                    </div>
                    {% if debrief.estimates_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.estimates_notes }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Membership</div>
                    <div class="{% if debrief.membership_verified == 'pass' %}text-christmas-green-light{% elif debrief.membership_verified == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.membership_verified|upper if debrief.membership_verified else 'N/A' }}
                    </div>
                    {% if debrief.membership_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.membership_notes }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Google Reviews</div>
                    <div class="{% if debrief.google_reviews_discussed == 'pass' %}text-christmas-green-light{% elif debrief.google_reviews_discussed == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.google_reviews_discussed|upper if debrief.google_reviews_discussed else 'N/A' }}
                    </div>
                    {% if debrief.google_reviews_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.google_reviews_notes }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Replacement</div>
                    <div class="{% if debrief.replacement_discussed == 'pass' %}text-christmas-green-light{% elif debrief.replacement_discussed == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.replacement_discussed|upper if debrief.replacement_discussed else 'N/A' }}
                    </div>
                    {% if debrief.no_replacement_reason %}<div class="text-xs text-gray-400 mt-1">{{ debrief.no_replacement_reason }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Equipment Added</div>
                    <div class="{% if debrief.equipment_added == 'pass' %}text-christmas-green-light{% elif debrief.equipment_added == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.equipment_added|upper if debrief.equipment_added else 'N/A' }}
                    </div>
                    {% if debrief.equipment_added_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.equipment_added_notes }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-christmas-gold/30">
                    <div class="text-xs text-christmas-gold mb-1">Materials on Invoice üí∞</div>
                    <div class="{% if debrief.materials_on_invoice == 'pass' %}text-christmas-green-light{% elif debrief.materials_on_invoice == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.materials_on_invoice|upper if debrief.materials_on_invoice else 'N/A' }}
                    </div>
                    {% if debrief.materials_on_invoice_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.materials_on_invoice_notes }}</div>{% endif %}
                </div>
                <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                    <div class="text-xs text-gray-500 mb-1">Happy Call</div>
                    <div class="{% if debrief.happy_call == 'pass' %}text-christmas-green-light{% elif debrief.happy_call == 'fail' %}text-christmas-brown{% else %}text-gray-500{% endif %} font-semibold">
                        {{ debrief.happy_call|upper if debrief.happy_call else 'N/A' }}
                    </div>
                    {% if debrief.happy_call_notes %}<div class="text-xs text-gray-400 mt-1">{{ debrief.happy_call_notes }}</div>{% endif %}
                </div>
            </div>

            <!-- Invoice Summary Notes -->
            {% if debrief.invoice_summary_notes %}
            <div class="bg-dark-bg rounded-lg p-4 border border-dark-border">
                <div class="text-xs text-gray-500 mb-2">Invoice Summary Notes</div>
                <div class="text-sm text-christmas-cream">{{ debrief.invoice_summary_notes }}</div>
            </div>
            {% endif %}

            <!-- G3 Contact -->
            {% if debrief.g3_contact_needed %}
            <div class="bg-christmas-gold/10 rounded-lg p-4 border border-christmas-gold/30">
                <div class="text-xs text-christmas-gold mb-2">‚ö†Ô∏è G3 Contact Needed</div>
                <div class="text-sm text-christmas-cream">{{ debrief.g3_notes or 'No details provided' }}</div>
            </div>
            {% endif %}

            <!-- General Notes -->
            {% if debrief.general_notes %}
            <div class="bg-dark-bg rounded-lg p-4 border border-dark-border">
                <div class="text-xs text-gray-500 mb-2">General Notes / Coaching Reminders</div>
                <div class="text-sm text-christmas-cream whitespace-pre-wrap">{{ debrief.general_notes }}</div>
            </div>
            {% endif %}

            <!-- Follow-up Section -->
            {% if debrief.followup_required %}
            <div class="bg-christmas-gold/10 rounded-lg p-4 border border-christmas-gold/30">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-christmas-gold font-semibold">‚ö†Ô∏è Follow-up Required</span>
                    {% if debrief.followup_completed %}
                    <span class="px-2 py-0.5 text-xs bg-christmas-green/20 text-christmas-green-light rounded">Completed</span>
                    {% else %}
                    <span class="px-2 py-0.5 text-xs bg-christmas-gold/20 text-christmas-gold rounded">Pending</span>
                    {% endif %}
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <div class="text-xs text-gray-500">Type</div>
                        <div class="text-christmas-cream">{{ debrief.followup_type|replace('_', ' ')|title if debrief.followup_type else 'Not specified' }}</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500">Assigned To</div>
                        <div class="text-christmas-cream">{{ debrief.followup_assigned_to or 'Unassigned' }}</div>
                    </div>
                </div>
                {% if debrief.followup_description %}
                <div class="mt-3">
                    <div class="text-xs text-gray-500 mb-1">Description</div>
                    <div class="text-sm text-christmas-cream">{{ debrief.followup_description }}</div>
                </div>
                {% endif %}
                {% if debrief.st_task_id %}
                <div class="mt-3 text-xs text-gray-500">
                    ServiceTitan Task #{{ debrief.st_task_id }} created
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Debrief Form (for new debriefs or re-debriefing) -->
    <form action="/api/job/{{ ticket.job_id }}/debrief/form" method="POST" class="bg-dark-card rounded-lg border border-dark-border {% if debrief %}opacity-60 hover:opacity-100 transition{% endif %}">
        <div class="px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-christmas-cream">{% if debrief %}Re-Debrief / Update{% else %}Debrief Checklist{% endif %}</h2>
            <p class="text-sm text-gray-500 mt-1">{% if debrief %}Submit again to update this debrief.{% else %}Complete all items before submitting.{% endif %}</p>
        </div>

        <div class="px-6 py-4 space-y-6">
            <!-- Dispatcher Selection -->
            <div>
                <label class="block text-sm font-medium text-christmas-cream mb-2">Dispatcher</label>
                <select name="dispatcher_id" required class="w-full md:w-1/2 rounded-md p-2 border">
                    <option value="">Select dispatcher...</option>
                    {% for d in dispatchers %}
                    <option value="{{ d.id }}">{{ d.name }}{% if d.is_primary %} (Primary){% endif %}</option>
                    {% endfor %}
                </select>
            </div>

            <hr class="border-dark-border">

            <!-- 1. Photos -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Photos Reviewed ({{ ticket.photo_count }} photos attached)
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-72 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Photos</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Before/after photos uploaded showing the work performed and equipment<br>
                            <span class="text-christmas-brown">Fail:</span> No photos, blurry photos, or missing key shots (before/after)<br>
                            <span class="text-gray-500">N/A:</span> Phone consultation, remote diagnostic, or admin-only visit
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="photos_reviewed" value="pass" class="sr-only" required>
                        <span>‚úì Pass</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="photos_reviewed" value="fail" class="sr-only">
                        <span>‚úó Fail</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="photos_reviewed" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="photos_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 2. Invoice Summary Score -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Invoice Summary Quality (1-10)
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-80 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Score Invoice Summary</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">8-10:</span> Clear diagnosis, detailed work description, recommendations for future, professional tone<br>
                            <span class="text-christmas-gold">5-7:</span> Basic info present but missing details or recommendations<br>
                            <span class="text-christmas-brown">1-4:</span> Vague, incomplete, or just "completed service"
                        </div>
                    </div>
                </label>
                <div class="flex items-center space-x-4">
                    <input type="range" name="invoice_summary_score" min="1" max="10" value="5"
                        class="w-48 h-2 rounded-lg appearance-none cursor-pointer"
                        oninput="document.getElementById('score-display').textContent = this.value">
                    <span id="score-display" class="text-2xl font-bold text-christmas-green-light w-8">5</span>
                    <span class="text-sm text-gray-500">/ 10</span>
                </div>
                <input type="text" name="invoice_summary_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 3. Payment -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Payment Verified
                    <span class="{% if ticket.payment_collected %}text-christmas-green-light{% else %}text-christmas-brown{% endif %}">
                        ({% if ticket.payment_collected %}Collected{% if ticket.payment_method %} via {{ ticket.payment_method }}{% endif %}{% else %}Not Collected - ${{ "{:,.2f}".format(ticket.invoice_balance) }} balance{% endif %})
                    </span>
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-80 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Payment</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Paid in full OR financing approved with proper notes in ServiceTitan<br>
                            <span class="text-christmas-brown">Fail:</span> Unpaid balance with no documented reason or payment plan<br>
                            <span class="text-gray-500">N/A:</span> Warranty work, no-charge diagnostic, or pre-approved commercial billing
                        </div>
                    </div>
                </label>
                {% if ticket.payment_method == 'Check' %}
                <div class="bg-yellow-900/30 border border-yellow-600/50 rounded-lg p-2 text-xs text-yellow-200">
                    ‚ö†Ô∏è <strong>Check collected but NOT deposited</strong> - Needs to be dropped off at the shop for deposit
                </div>
                {% elif ticket.payment_method == 'Mobile Check Capture' %}
                <div class="bg-green-900/30 border border-green-600/50 rounded-lg p-2 text-xs text-green-200">
                    ‚úì Check deposited via mobile
                </div>
                {% endif %}
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="payment_verified" value="pass" class="sr-only" required {% if ticket.payment_collected and ticket.payment_method %}checked{% endif %}>
                        <span>‚úì Pass</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="payment_verified" value="fail" class="sr-only">
                        <span>‚úó Fail</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="payment_verified" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="no_payment_reason" placeholder="If not collected, why?"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 4. Estimates -->
            <div class="space-y-2 {% if ticket.is_opportunity %}ring-2 ring-christmas-gold/50 rounded-lg p-3 -mx-3{% endif %}">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Estimates Offered/Discussed ({{ ticket.estimate_count }} created{% if ticket.estimates_total %}, ${{ "{:,.2f}".format(ticket.estimates_total) }} total{% endif %})
                    {% if ticket.is_opportunity %}
                    <span class="ml-2 text-christmas-gold text-xs font-semibold">üéØ OPPORTUNITY JOB - Estimates Expected</span>
                    {% endif %}
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-80 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Estimates</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Estimate created for additional repairs, replacements, or upgrades<br>
                            <span class="text-christmas-brown">Fail:</span> Opportunity job (üéØ) with no estimates presented to customer<br>
                            <span class="text-gray-500">N/A:</span> Simple maintenance, tune-up, or no reasonable upsell opportunity
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="estimates_verified" value="pass" class="sr-only" required>
                        <span>‚úì Pass</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="estimates_verified" value="fail" class="sr-only">
                        <span>‚úó Fail</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="estimates_verified" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="estimates_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 5. Membership -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Membership Offered
                    <span class="{% if ticket.membership_sold %}text-christmas-green-light{% else %}text-gray-500{% endif %}">
                        ({{ "Sold: " + (ticket.membership_type or "Unknown") if ticket.membership_sold else "Not Sold" }})
                    </span>
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-72 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Membership</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Maintenance plan was offered and explained to customer<br>
                            <span class="text-christmas-brown">Fail:</span> Not offered when customer was eligible<br>
                            <span class="text-gray-500">N/A:</span> Customer already has active membership or commercial account
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="membership_verified" value="pass" class="sr-only" required>
                        <span>‚úì Pass</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="membership_verified" value="fail" class="sr-only">
                        <span>‚úó Fail</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="membership_verified" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="membership_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 6. Google Reviews -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Google Reviews Discussed
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-72 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Google Reviews</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Tech asked customer to leave a Google review<br>
                            <span class="text-christmas-brown">Fail:</span> Not mentioned to a satisfied customer<br>
                            <span class="text-gray-500">N/A:</span> Customer was unhappy, complaint situation, or not appropriate to ask
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="google_reviews_discussed" value="pass" class="sr-only" required>
                        <span>‚úì Pass</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="google_reviews_discussed" value="fail" class="sr-only">
                        <span>‚úó Fail</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="google_reviews_discussed" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="google_reviews_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 7. Replacement Discussion -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Replacement Discussed (if aged equipment)
                    {% if ticket.equipment_age_years %}
                    <span class="{% if ticket.equipment_age_years >= 12 %}text-christmas-gold{% else %}text-gray-500{% endif %}">
                        (Equipment age: {{ ticket.equipment_age_years }} years)
                    </span>
                    {% endif %}
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-72 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Replacement Discussion</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Replacement options discussed for equipment 12+ years old<br>
                            <span class="text-christmas-brown">Fail:</span> Old equipment but no replacement conversation<br>
                            <span class="text-gray-500">N/A:</span> Newer equipment, or replacement not relevant to visit type
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="replacement_discussed" value="pass" class="sr-only" required>
                        <span>‚úì Pass</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="replacement_discussed" value="fail" class="sr-only">
                        <span>‚úó Fail</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="replacement_discussed" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="no_replacement_reason" placeholder="If not discussed, why?"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 8. Equipment Added to Location -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Equipment Added to ST Location?
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-72 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Equipment Added</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Equipment serviced/installed was added to customer's ST location record<br>
                            <span class="text-christmas-brown">Fail:</span> Equipment not added or updated in ServiceTitan<br>
                            <span class="text-gray-500">N/A:</span> No equipment involved (drain cleaning, etc.) or equipment already on file
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="equipment_added" value="pass" class="sr-only" required>
                        <span>‚úì Yes</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="equipment_added" value="fail" class="sr-only">
                        <span>‚úó No</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="equipment_added" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="equipment_added_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 9. Materials/Equipment on Invoice (for Gross Margin) -->
            <div class="space-y-2 bg-christmas-gold/5 border border-christmas-gold/20 rounded-lg p-4 -mx-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Materials & Equipment on Invoice?
                    <span class="text-christmas-gold text-xs ml-1">üí∞ Critical for Gross Margin</span>
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-80 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Materials on Invoice</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> All parts, materials, and equipment used are itemized on invoice<br>
                            <span class="text-christmas-brown">Fail:</span> Missing items - tech used materials not charged to customer<br>
                            <span class="text-gray-500">N/A:</span> Diagnostic only, no materials used
                        </div>
                    </div>
                </label>
                <p class="text-xs text-gray-400 mb-2">Ask tech: "Did you add all materials and equipment used to the invoice?"</p>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="materials_on_invoice" value="pass" class="sr-only" required>
                        <span>‚úì Yes - All Added</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="materials_on_invoice" value="fail" class="sr-only">
                        <span>‚úó No - Missing Items</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="materials_on_invoice" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="materials_on_invoice_notes" placeholder="Tech response / missing items..."
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 10. Happy Call -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream group relative cursor-help">
                    Happy Call Completed
                    <span class="ml-1 text-gray-500 text-xs">‚ìò</span>
                    <div class="absolute left-0 bottom-full mb-2 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-xs text-left w-72 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                        <div class="font-semibold text-christmas-cream mb-1">How to Grade Happy Call</div>
                        <div class="text-gray-400 font-normal">
                            <span class="text-christmas-green-light">Pass:</span> Happy call completed, customer confirmed satisfaction<br>
                            <span class="text-christmas-brown">Fail:</span> Happy call attempted but customer had concerns or complaints<br>
                            <span class="text-gray-500">N/A:</span> Unable to reach customer, voicemail left, or not applicable
                        </div>
                    </div>
                </label>
                <div class="radio-group">
                    <label class="pass-option">
                        <input type="radio" name="happy_call" value="pass" class="sr-only" required>
                        <span>‚úì Yes</span>
                    </label>
                    <label class="fail-option">
                        <input type="radio" name="happy_call" value="fail" class="sr-only">
                        <span>‚úó No</span>
                    </label>
                    <label class="na-option">
                        <input type="radio" name="happy_call" value="na" class="sr-only">
                        <span>N/A</span>
                    </label>
                </div>
                <input type="text" name="happy_call_notes" placeholder="Notes (optional)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <!-- 11. G3 Contact -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream">G3 Contact Needed?</label>
                <div class="flex items-center space-x-4">
                    <label class="flex items-center text-gray-300">
                        <input type="radio" name="g3_contact_needed" value="false" checked class="mr-2">
                        <span>No</span>
                    </label>
                    <label class="flex items-center text-gray-300">
                        <input type="radio" name="g3_contact_needed" value="true" class="mr-2">
                        <span>Yes</span>
                    </label>
                </div>
                <input type="text" name="g3_notes" placeholder="G3 notes (if needed)"
                    class="mt-2 w-full rounded-md p-2 border text-sm">
            </div>

            <hr class="border-dark-border">

            <!-- Follow-up Section -->
            <div class="bg-christmas-gold/10 border border-christmas-gold/30 rounded-lg p-4 space-y-4">
                <div class="flex items-center justify-between">
                    <label class="text-sm font-semibold text-christmas-gold">Follow-up Required?</label>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center text-gray-300">
                            <input type="radio" name="followup_required" value="false" checked
                                class="mr-2" onchange="toggleFollowup(false)">
                            <span>No</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="followup_required" value="true"
                                class="mr-2" onchange="toggleFollowup(true)">
                            <span class="text-christmas-gold font-medium">Yes - Flag for follow-up</span>
                        </label>
                    </div>
                </div>

                <div id="followup-details" class="hidden space-y-4 pt-4 border-t border-christmas-gold/30">
                    <div>
                        <label class="block text-sm font-medium text-christmas-cream mb-2">Follow-up Type</label>
                        <select name="followup_type" class="w-full md:w-1/2 rounded-md p-2 border">
                            <option value="">Select type...</option>
                            <option value="tech_coaching">üéì Tech Coaching Needed</option>
                            <option value="manager_review">üëî Manager Review Required</option>
                            <option value="customer_callback">üìû Customer Callback Needed</option>
                            <option value="billing">üí∞ Billing Issue</option>
                            <option value="quality">‚ö†Ô∏è Quality Issue</option>
                            <option value="other">üìå Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-christmas-cream mb-2">Assign To</label>
                        <input type="text" name="followup_assigned_to"
                            placeholder="Tech name, manager, or leave blank"
                            class="w-full md:w-1/2 rounded-md p-2 border text-sm">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-christmas-cream mb-2">Follow-up Description</label>
                        <textarea name="followup_description" rows="2"
                            placeholder="What needs to be addressed? Be specific..."
                            class="w-full rounded-md p-2 border"></textarea>
                    </div>

                    <div class="flex items-center space-x-2 text-sm text-christmas-gold">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm0 14a6 6 0 110-12 6 6 0 010 12zm-1-5h2v2H9v-2zm0-6h2v4H9V5z"/>
                        </svg>
                        <span>This will send a notification to Slack #debrief-followups</span>
                    </div>
                </div>
            </div>

            <hr class="border-dark-border">

            <!-- General Notes -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-christmas-cream">General Notes / Coaching Reminders</label>
                <textarea name="general_notes" rows="3" placeholder="Any additional notes for this debrief..."
                    class="w-full rounded-md p-2 border"></textarea>
            </div>
        </div>

        <!-- Submit -->
        <div class="px-6 py-4 bg-dark-bg rounded-b-lg flex justify-between items-center border-t border-dark-border">
            <a href="/queue" class="text-gray-500 hover:text-christmas-cream transition">Cancel</a>
            <button type="submit"
                class="bg-christmas-green hover:bg-christmas-green-dark text-christmas-cream font-semibold py-3 px-8 rounded-lg shadow transition">
                Complete Debrief ‚úì
            </button>
        </div>
    </form>
</div>

<script>
function toggleFollowup(show) {
    const details = document.getElementById('followup-details');
    if (show) {
        details.classList.remove('hidden');
    } else {
        details.classList.add('hidden');
    }
}

async function addToSpotCheck(debriefSessionId) {
    if (!confirm('Add this job to the spot check queue?')) return;

    try {
        const response = await fetch(`/api/spot-checks/manual/${debriefSessionId}`, { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            alert('Added to spot check queue!');
            // Redirect to the spot check form
            window.location.href = `/spot-check/${result.spot_check_id}`;
        } else {
            alert(result.message || 'Failed to add spot check');
        }
    } catch (error) {
        console.error('Failed to add spot check:', error);
        alert('Failed to add spot check');
    }
}
</script>
{% endblock %}
