{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header Stats -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="bg-dark-card rounded-lg border border-dark-border p-4">
            <div class="text-sm font-medium text-gray-500 flex items-center gap-1">
                Pending
                <div class="relative group/tip">
                    <span class="cursor-help text-gray-600">â“˜</span>
                    <div class="absolute left-0 top-full mt-2 p-2 bg-dark-bg border border-dark-border rounded-lg shadow-xl z-50 w-48 hidden group-hover/tip:block text-xs text-christmas-cream font-normal">
                        Jobs completed in ServiceTitan waiting to be debriefed.
                    </div>
                </div>
            </div>
            <div class="mt-1 text-2xl font-bold text-christmas-gold">{{ pending_count }}</div>
        </div>
        <div class="bg-dark-card rounded-lg border border-dark-border p-4">
            <div class="text-sm font-medium text-gray-500 flex items-center gap-1">
                In Progress
                <div class="relative group/tip">
                    <span class="cursor-help text-gray-600">â“˜</span>
                    <div class="absolute left-0 top-full mt-2 p-2 bg-dark-bg border border-dark-border rounded-lg shadow-xl z-50 w-48 hidden group-hover/tip:block text-xs text-christmas-cream font-normal">
                        Debriefs started but not yet submitted.
                    </div>
                </div>
            </div>
            <div class="mt-1 text-2xl font-bold text-christmas-green-light">{{ in_progress_tickets|length }}</div>
        </div>
        <div class="bg-dark-card rounded-lg border border-dark-border p-4">
            <div class="text-sm font-medium text-gray-500 flex items-center gap-1">
                Jobs Today
                <div class="relative group/tip">
                    <span class="cursor-help text-gray-600">â“˜</span>
                    <div class="absolute left-0 top-full mt-2 p-2 bg-dark-bg border border-dark-border rounded-lg shadow-xl z-50 w-48 hidden group-hover/tip:block text-xs text-christmas-cream font-normal">
                        Total jobs marked completed by techs in ST today.
                    </div>
                </div>
            </div>
            <div class="mt-1 text-2xl font-bold text-christmas-green-light">{{ jobs_completed_today }}</div>
        </div>
        <div class="bg-dark-card rounded-lg border border-dark-border p-4">
            <div class="text-sm font-medium text-gray-500 flex items-center gap-1">
                Debriefs Today
                <div class="relative group/tip">
                    <span class="cursor-help text-gray-600">â“˜</span>
                    <div class="absolute left-0 top-full mt-2 p-2 bg-dark-bg border border-dark-border rounded-lg shadow-xl z-50 w-48 hidden group-hover/tip:block text-xs text-christmas-cream font-normal">
                        Debrief forms completed today. Goal: match Jobs Today.
                    </div>
                </div>
            </div>
            <div class="mt-1 text-2xl font-bold text-christmas-green-light">{{ debriefs_completed_today }}</div>
        </div>
        <div class="bg-dark-card rounded-lg border border-dark-border p-4">
            <div class="text-sm font-medium text-gray-500 flex items-center gap-1">
                Rate
                <div class="relative group/tip">
                    <span class="cursor-help text-gray-600">â“˜</span>
                    <div class="absolute left-0 top-full mt-2 p-2 bg-dark-bg border border-dark-border rounded-lg shadow-xl z-50 w-48 hidden group-hover/tip:block text-xs text-christmas-cream font-normal">
                        Debriefs Ã· Jobs Today. Target: 100% by end of day.
                    </div>
                </div>
            </div>
            <div class="mt-1 text-2xl font-bold text-christmas-green-light">
                {% if jobs_completed_today > 0 %}
                    {{ "%.0f"|format((debriefs_completed_today / jobs_completed_today) * 100) }}%
                {% else %}
                    --
                {% endif %}
            </div>
        </div>
    </div>

    <!-- In Progress Section -->
    {% if in_progress_tickets %}
    <div class="bg-dark-card rounded-lg border border-dark-border">
        <div class="px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-christmas-green-light">In Progress</h2>
        </div>
        <div class="divide-y divide-dark-border">
            {% for ticket in in_progress_tickets %}
            <div class="px-6 py-3 hover:bg-dark-card-hover transition cursor-pointer" onclick="window.location='/debrief/{{ ticket.job_id }}'">
                <div class="grid grid-cols-12 gap-2 items-center">
                    <!-- Col 1: Job Info (4 cols) -->
                    <div class="col-span-4">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-christmas-cream">Job #{{ ticket.job_number }}</span>
                            <span class="px-1.5 py-0.5 text-xs rounded bg-dark-border text-gray-400">{{ (ticket.business_unit_name or '').split()[0] or '?' }}</span>
                            <a href="https://go.servicetitan.com/#/Job/Index/{{ ticket.job_id }}"
                               target="_blank"
                               onclick="event.stopPropagation();"
                               class="text-xs text-christmas-green-light hover:text-christmas-green hover:underline">
                                ST â†—
                            </a>
                        </div>
                        <div class="flex items-center gap-2 mt-1 flex-nowrap">
                            {% if ticket.completed_at %}
                            <span class="text-xs text-gray-500 whitespace-nowrap">{{ ticket.completed_at.strftime('%m/%d %I:%M%p').lower() }}</span>
                            {% endif %}
                            <span class="px-2 py-0.5 text-xs rounded-full bg-christmas-green/20 text-christmas-green-light whitespace-nowrap truncate max-w-[160px]" title="{{ ticket.job_type_name or 'Unknown' }}">{{ ticket.job_type_name or 'Unknown' }}</span>
                            {% if ticket.is_opportunity %}
                            <span class="px-2 py-0.5 text-xs rounded-full bg-christmas-gold/30 text-christmas-gold font-semibold whitespace-nowrap" title="Conversion Opportunity - Estimates Expected">ðŸŽ¯</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Col 2: Customer + Tech (2 cols) -->
                    <div class="col-span-2 -ml-2">
                        <div class="text-sm text-christmas-cream truncate">{{ ticket.customer_name or 'Unknown' }}</div>
                        <div class="text-xs text-gray-500 truncate relative group/tech">
                            {% if ticket.all_techs and ticket.all_techs|length > 1 %}
                                {{ ticket.tech_name or 'Unassigned' }} <span class="text-christmas-gold">+{{ ticket.all_techs|length - 1 }}</span>
                                <div class="absolute left-0 top-full mt-1 p-2 bg-dark-bg border border-dark-border rounded-lg shadow-xl z-50 hidden group-hover/tech:block">
                                    <div class="text-xs text-gray-400 mb-1">All Techs:</div>
                                    {% for tech in ticket.all_techs %}
                                    <div class="text-xs text-christmas-cream">{{ tech.name }}</div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                {{ ticket.tech_name or 'Unassigned' }}
                            {% endif %}
                        </div>
                    </div>

                    <!-- Col 3: Invoice Summary (3 cols) -->
                    <div class="col-span-3 relative group -ml-2" onclick="event.stopPropagation();">
                        {% if ticket.invoice_summary %}
                        <div class="text-sm text-gray-400 truncate cursor-help">
                            {{ ticket.invoice_summary[:45] }}{% if ticket.invoice_summary|length > 45 %}...{% endif %}
                        </div>
                        <div class="absolute left-0 top-full mt-2 p-3 bg-dark-bg border border-dark-border rounded-lg shadow-xl z-50 w-96 hidden group-hover:block">
                            <div class="text-sm text-christmas-cream whitespace-pre-wrap">{{ ticket.invoice_summary }}</div>
                            {% if ticket.invoice_author %}
                            <div class="text-xs text-gray-500 mt-2 pt-2 border-t border-dark-border">Written by: {{ ticket.invoice_author }}</div>
                            {% endif %}
                        </div>
                        {% else %}
                        <span class="text-gray-600 text-sm">--</span>
                        {% endif %}
                    </div>

                    <!-- Col 4: Price & Stats (2 cols) -->
                    <div class="col-span-2 text-right pl-2">
                        <div class="text-lg font-semibold text-christmas-cream">${{ "{:,.2f}".format(ticket.invoice_total) }}</div>
                        <div class="flex items-center justify-end gap-3 text-xs mt-0.5">
                            <span class="{% if ticket.payment_collected %}text-christmas-green-light{% else %}text-christmas-brown{% endif %}">
                                {% if ticket.payment_collected %}âœ“ Paid{% else %}âœ— Unpaid{% endif %}
                            </span>
                            <span class="text-gray-500">ðŸ“· {{ ticket.photo_count or 0 }}</span>
                            <span class="text-gray-500">ðŸ’° {{ ticket.estimate_count }}</span>
                        </div>
                    </div>

                    <!-- Col 5: Reset Button (1 col) -->
                    <div class="col-span-1 text-right" onclick="event.stopPropagation();">
                        <button onclick="resetJobStatus({{ ticket.job_id }})"
                                title="Return to pending queue"
                                class="text-xs text-gray-400 hover:text-christmas-cream bg-dark-border hover:bg-dark-card-hover px-2 py-1 rounded transition">
                            â†© Reset
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Pending Queue -->
    <div class="bg-dark-card rounded-lg border border-dark-border">
        <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
            <h2 class="text-lg font-semibold text-christmas-gold">Pending Debrief ({{ pending_count }})</h2>
            <div class="flex items-center gap-3">
                <button id="sync-btn" onclick="syncJobs()" title="Pull new completed jobs from ServiceTitan API" class="text-sm text-christmas-cream bg-christmas-green/20 hover:bg-christmas-green/30 px-3 py-1 rounded-lg border border-christmas-green/50 transition flex items-center gap-2">
                    <span id="sync-icon">âŸ³</span>
                    <span id="sync-text">Sync from ST</span>
                </button>
                <button onclick="location.reload()" title="Reload page with current data" class="text-sm text-christmas-green-light hover:text-christmas-green">
                    â†» Refresh
                </button>
            </div>
        </div>

        {% if pending_tickets %}
        <div class="divide-y divide-dark-border">
            {% for ticket in pending_tickets %}
            <div class="px-6 py-3 hover:bg-dark-card-hover transition cursor-pointer" onclick="window.location='/debrief/{{ ticket.job_id }}'">
                <div class="grid grid-cols-12 gap-2 items-center">
                    <!-- Col 1: Job Info (4 cols) -->
                    <div class="col-span-4">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-christmas-cream">Job #{{ ticket.job_number }}</span>
                            <span class="px-1.5 py-0.5 text-xs rounded bg-dark-border text-gray-400">{{ (ticket.business_unit_name or '').split()[0] or '?' }}</span>
                            <a href="https://go.servicetitan.com/#/Job/Index/{{ ticket.job_id }}"
                               target="_blank"
                               onclick="event.stopPropagation();"
                               class="text-xs text-christmas-green-light hover:text-christmas-green hover:underline">
                                ST â†—
                            </a>
                        </div>
                        <div class="flex items-center gap-2 mt-1 flex-nowrap">
                            {% if ticket.completed_at %}
                            <span class="text-xs text-gray-500 whitespace-nowrap">{{ ticket.completed_at.strftime('%m/%d %I:%M%p').lower() }}</span>
                            {% endif %}
                            <span class="px-2 py-0.5 text-xs rounded-full bg-christmas-gold/20 text-christmas-gold whitespace-nowrap truncate max-w-[160px]" title="{{ ticket.job_type_name or 'Unknown' }}">{{ ticket.job_type_name or 'Unknown' }}</span>
                            {% if ticket.is_opportunity %}
                            <span class="px-2 py-0.5 text-xs rounded-full bg-christmas-gold/30 text-christmas-gold font-semibold whitespace-nowrap" title="Conversion Opportunity - Estimates Expected">ðŸŽ¯</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Col 2: Customer + Tech (2 cols) -->
                    <div class="col-span-2 -ml-2">
                        <div class="text-sm text-christmas-cream truncate">{{ ticket.customer_name or 'Unknown' }}</div>
                        <div class="text-xs text-gray-500 truncate relative group/tech">
                            {% if ticket.all_techs and ticket.all_techs|length > 1 %}
                                {{ ticket.tech_name or 'Unassigned' }} <span class="text-christmas-gold">+{{ ticket.all_techs|length - 1 }}</span>
                                <div class="absolute left-0 top-full mt-1 p-2 bg-dark-bg border border-dark-border rounded-lg shadow-xl z-50 hidden group-hover/tech:block">
                                    <div class="text-xs text-gray-400 mb-1">All Techs:</div>
                                    {% for tech in ticket.all_techs %}
                                    <div class="text-xs text-christmas-cream">{{ tech.name }}</div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                {{ ticket.tech_name or 'Unassigned' }}
                            {% endif %}
                        </div>
                    </div>

                    <!-- Col 3: Invoice Summary (3 cols) -->
                    <div class="col-span-3 relative group -ml-2" onclick="event.stopPropagation();">
                        {% if ticket.invoice_summary %}
                        <div class="text-sm text-gray-400 truncate cursor-help">
                            {{ ticket.invoice_summary[:45] }}{% if ticket.invoice_summary|length > 45 %}...{% endif %}
                        </div>
                        <div class="absolute left-0 top-full mt-2 p-3 bg-dark-bg border border-dark-border rounded-lg shadow-xl z-50 w-96 hidden group-hover:block">
                            <div class="text-sm text-christmas-cream whitespace-pre-wrap">{{ ticket.invoice_summary }}</div>
                            {% if ticket.invoice_author %}
                            <div class="text-xs text-gray-500 mt-2 pt-2 border-t border-dark-border">Written by: {{ ticket.invoice_author }}</div>
                            {% endif %}
                        </div>
                        {% else %}
                        <span class="text-gray-600 text-sm">--</span>
                        {% endif %}
                    </div>

                    <!-- Col 4: Price & Stats (3 cols) -->
                    <div class="col-span-3 text-right pl-2">
                        <div class="text-lg font-semibold text-christmas-cream">${{ "{:,.2f}".format(ticket.invoice_total) }}</div>
                        <div class="flex items-center justify-end gap-3 text-xs mt-0.5">
                            <span class="{% if ticket.payment_collected %}text-christmas-green-light{% else %}text-christmas-brown{% endif %}">
                                {% if ticket.payment_collected %}âœ“ Paid{% else %}âœ— Unpaid{% endif %}
                            </span>
                            <span class="text-gray-500">ðŸ“· {{ ticket.photo_count or 0 }}</span>
                            <span class="text-gray-500">ðŸ“‹ {{ ticket.form_count or 0 }}</span>
                            <span class="text-gray-500">ðŸ’° {{ ticket.estimate_count }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="px-6 py-12 text-center text-gray-500">
            <div class="text-4xl mb-4">ðŸŽ„</div>
            <div class="text-lg text-christmas-cream">All caught up!</div>
            <div class="text-sm mt-2">No jobs pending debrief.</div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-refresh every 30 seconds
    setTimeout(() => location.reload(), 30000);

    // Reset job status back to pending
    async function resetJobStatus(jobId) {
        try {
            const response = await fetch(`/api/job/${jobId}/reset-status`, { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                location.reload();
            } else {
                alert(result.message || 'Could not reset job status');
            }
        } catch (error) {
            console.error('Reset error:', error);
            alert('Error resetting job status');
        }
    }

    // Sync jobs from ServiceTitan
    async function syncJobs() {
        const btn = document.getElementById('sync-btn');
        const icon = document.getElementById('sync-icon');
        const text = document.getElementById('sync-text');

        // Disable button and show loading
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        icon.classList.add('animate-spin');
        text.textContent = 'Syncing...';

        try {
            const response = await fetch('/api/sync?hours_back=4', { method: 'POST' });
            const result = await response.json();

            if (result.status === 'success') {
                text.textContent = `+${result.added_count} jobs`;
                icon.classList.remove('animate-spin');

                // Reload page after short delay to show results
                setTimeout(() => location.reload(), 1000);
            } else {
                text.textContent = 'Error';
                icon.classList.remove('animate-spin');
                console.error('Sync error:', result);

                // Reset button after delay
                setTimeout(() => {
                    text.textContent = 'Sync from ST';
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }, 3000);
            }
        } catch (error) {
            console.error('Sync failed:', error);
            text.textContent = 'Failed';
            icon.classList.remove('animate-spin');

            setTimeout(() => {
                text.textContent = 'Sync from ST';
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }, 3000);
        }
    }
</script>
<style>
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .animate-spin {
        animation: spin 1s linear infinite;
        display: inline-block;
    }
</style>
{% endblock %}
